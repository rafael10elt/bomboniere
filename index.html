<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doce Gestão - Sistema de Bomboniere</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #fdf2f8; /* pink-50 */
            --bg-secondary: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.6);
            --text-primary: #581c87; /* purple-900 */
            --text-secondary: #6b7280; /* gray-500 */
            --text-title: #db2777; /* pink-600 */
            --border-color: rgba(0, 0, 0, 0.1);
            --input-bg: #f5d0fe; /* fuchsia-200 */
            --input-border: #e879f9; /* fuchsia-400 */
            --btn-bg: #fbcfe8; /* pink-200 */
            --btn-border: #f9a8d4; /* pink-300 */
            --btn-hover-bg: #f9a8d4; /* pink-300 */
            --accent-pink: #db2777;
            --accent-purple: #9333ea;
        }

        .dark-theme {
            --bg-primary: #1e1b2e;
            --bg-secondary: #2a273f;
            --glass-bg: rgba(42, 39, 63, 0.6);
            --text-primary: #f3e8ff; /* purple-50 */
            --text-secondary: #a8a29e; /* stone-400 */
            --text-title: #f472b6; /* pink-400 */
            --border-color: rgba(255, 255, 255, 0.15);
            --input-bg: #3b385e;
            --input-border: #5a568a;
            --btn-bg: #5a568a;
            --btn-border: #7c78aa;
            --btn-hover-bg: #7c78aa;
            --accent-pink: #f472b6;
            --accent-purple: #c084fc;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .font-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }

        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .glow-text {
            text-shadow: 0 0 8px var(--accent-pink);
        }
        .light-theme .glow-text {
            text-shadow: none;
        }

        .action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: background-color 0.2s;
            color: var(--text-secondary);
        }
        .action-btn:hover {
            background-color: rgba(127, 127, 127, 0.1);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .dark-theme ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .dark-theme ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Input Styles */
        .custom-input, .custom-select {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        .custom-input::placeholder {
            color: var(--text-secondary);
        }

        .view-btn-inactive {
            color: var(--text-secondary);
            background-color: transparent;
        }
        .view-btn-inactive:hover {
            background-color: var(--btn-hover-bg);
        }
        .view-btn-active {
            background-color: var(--accent-pink);
            color: white;
            box-shadow: 0 2px 10px -2px var(--accent-pink);
        }
        
        .stock-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .stock-status-ok { background-color: #dcfce7; color: #166534; }
        .stock-status-low { background-color: #fef9c3; color: #854d0e; }
        .stock-status-out { background-color: #fee2e2; color: #991b1b; }

        .dark-theme .stock-status-ok { background-color: #14532d; color: #bbf7d0; }
        .dark-theme .stock-status-low { background-color: #713f12; color: #fde047; }
        .dark-theme .stock-status-out { background-color: #7f1d1d; color: #fecaca; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }

    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-full">
        <!-- HEADER -->
        <header class="flex items-center justify-between gap-4 mb-10">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-pink-200 dark:bg-pink-500 rounded-full flex items-center justify-center text-2xl font-bold text-pink-600 dark:text-white">
                    DG
                </div>
                <h1 class="text-3xl sm:text-4xl font-title" style="color: var(--text-title);">Doce Gestão</h1>
            </div>
            <button id="themeToggleBtn" class="action-btn p-2 rounded-full" title="Alternar tema">
                <svg id="theme-icon-sun" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-icon-moon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Coluna de Registro de Venda -->
            <div class="lg:col-span-1">
                <div class="glass-effect rounded-lg shadow-2xl p-6 h-full">
                    <h2 class="text-2xl font-semibold mb-5 font-title" style="color: var(--text-title);">Registrar Venda</h2>
                    <form id="salesForm" class="space-y-4">
                        <div>
                            <label for="sale-product" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Produto</label>
                            <select id="sale-product" name="produto" required class="custom-select"></select>
                        </div>
                        <div>
                            <label for="sale-quantity" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Quantidade</label>
                            <input type="number" id="sale-quantity" name="quantidade" required placeholder="0" min="1" class="custom-input">
                        </div>
                        <div class="pt-4">
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white" style="background-color: var(--accent-pink); hover:opacity-90;">
                                Confirmar Venda
                            </button>
                        </div>
                    </form>
                    <div id="sale-feedback" class="mt-4 text-center"></div>
                </div>
            </div>

            <!-- Coluna Principal (Estoque e Vendas) -->
            <div class="lg:col-span-2">
                <div class="glass-effect p-4 sm:p-6 rounded-lg shadow-2xl">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-5 gap-4">
                        <div class="flex items-center gap-2 p-1 rounded-md flex-shrink-0" style="background-color: var(--btn-bg);">
                            <button id="viewEstoqueBtn" class="px-3 py-1 text-sm rounded-md view-btn-active">Estoque</button>
                            <button id="viewVendasBtn" class="px-3 py-1 text-sm rounded-md view-btn-inactive">Vendas</button>
                        </div>
                        <button id="refreshButton" class="action-btn p-2 rounded-full" title="Atualizar dados">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>
                        </button>
                    </div>
                    
                    <!-- Filtros -->
                    <div id="estoqueFilters" class="flex flex-col sm:flex-row sm:flex-wrap items-center gap-2 w-full mb-5">
                        <select id="filterCategoria" class="custom-select sm:w-auto">
                            <option value="todos">Todas Categorias</option>
                        </select>
                        <select id="filterStatusEstoque" class="custom-select sm:w-auto">
                            <option value="todos">Todos Status</option>
                            <option value="ok">Em Estoque</option>
                            <option value="low">Estoque Baixo</option>
                            <option value="out">Esgotado</option>
                        </select>
                    </div>
                     <div id="vendasFilters" class="hidden flex-col sm:flex-row sm:flex-wrap items-center gap-2 w-full mb-5">
                        <input type="date" id="filterVendasDate" class="custom-input sm:w-auto">
                    </div>

                    <!-- Views Container -->
                    <div>
                        <!-- View de Estoque -->
                        <div id="estoqueView">
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="border-b" style="border-color: var(--border-color);">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Produto</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Categoria</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Preço</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Estoque</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Status</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="estoqueList"></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- View de Vendas -->
                        <div id="vendasView" class="hidden">
                             <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="border-b" style="border-color: var(--border-color);">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Data</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Produto</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Qtd.</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Total (R$)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vendasList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Edição de Produto -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-semibold mb-5 font-title" style="color: var(--text-title);">Editar Produto</h2>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="edit-id" name="id">
                <input type="text" id="edit-nome" name="nome" required placeholder="Nome do Produto" class="custom-input">
                <input type="text" id="edit-categoria" name="categoria" required placeholder="Categoria" class="custom-input">
                <input type="number" id="edit-preco" name="preco" required placeholder="Preço (ex: 9.99)" step="0.01" min="0" class="custom-input">
                <input type="number" id="edit-estoque" name="estoque" required placeholder="Quantidade em Estoque" step="1" min="0" class="custom-input">
                <div class="flex gap-4 pt-4">
                    <button type="button" id="cancelEdit" class="w-full justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button>
                    <button type="submit" class="w-full justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white" style="background-color: var(--accent-pink);">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
        <div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-md text-center">
            <h2 class="text-2xl font-semibold mb-5 text-yellow-400 font-title">Confirmar Exclusão</h2>
            <p class="mb-6">Tem certeza de que deseja apagar este produto? Esta ação não pode ser desfeita.</p>
            <div class="flex gap-4 pt-4">
                <button type="button" id="cancelDelete" class="w-full justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button>
                <button type="button" id="confirmDelete" class="w-full justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">Apagar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Configuração da API (Simulada) ---
        // Em um projeto real, substitua isso pela URL da sua API (ex: NocoDB, Supabase, etc.)
        const API_URL = 'https://api.example.com'; 
        const API_TOKEN = 'your_api_token';
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_TOKEN}` };

        // --- Dados de Demonstração (Simulando um Banco de Dados) ---
        let mockProdutos = [
            { Id: 1, nome: 'Brigadeiro Gourmet', categoria: 'Doces', preco: 4.50, estoque: 50 },
            { Id: 2, nome: 'Caixa de Bombom', categoria: 'Chocolates', preco: 25.00, estoque: 8 },
            { Id: 3, nome: 'Bala de Goma (100g)', categoria: 'Balas', preco: 6.00, estoque: 80 },
            { Id: 4, nome: 'Pirulito Colorido', categoria: 'Balas', preco: 1.50, estoque: 120 },
            { Id: 5, nome: 'Barra de Chocolate Amargo', categoria: 'Chocolates', preco: 12.00, estoque: 0 },
            { Id: 6, nome: 'Paçoca', categoria: 'Doces', preco: 2.00, estoque: 45 },
        ];
        let mockVendas = [
            { Id: 101, produtoId: 3, produtoNome: "Bala de Goma (100g)", quantidade: 2, total: 12.00, data: '2025-09-23T10:00:00Z' },
            { Id: 102, produtoId: 1, produtoNome: "Brigadeiro Gourmet", quantidade: 5, total: 22.50, data: '2025-09-24T14:30:00Z' },
        ];
        let nextProductId = 7;
        let nextVendaId = 103;

        // --- Estado da Aplicação ---
        let allProdutos = [];
        let allVendas = [];
        let currentView = 'estoque'; // 'estoque' ou 'vendas'
        const LOW_STOCK_THRESHOLD = 10;

        // --- Seletores de UI ---
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const sunIcon = document.getElementById('theme-icon-sun');
        const moonIcon = document.getElementById('theme-icon-moon');
        const viewEstoqueBtn = document.getElementById('viewEstoqueBtn');
        const viewVendasBtn = document.getElementById('viewVendasBtn');
        const estoqueView = document.getElementById('estoqueView');
        const vendasView = document.getElementById('vendasView');
        const estoqueList = document.getElementById('estoqueList');
        const vendasList = document.getElementById('vendasList');
        const refreshButton = document.getElementById('refreshButton');
        
        // Modals
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const cancelEdit = document.getElementById('cancelEdit');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');

        // Forms e Filtros
        const salesForm = document.getElementById('salesForm');
        const saleProductSelect = document.getElementById('sale-product');
        const saleFeedback = document.getElementById('sale-feedback');
        const estoqueFilters = document.getElementById('estoqueFilters');
        const vendasFilters = document.getElementById('vendasFilters');
        const filterCategoria = document.getElementById('filterCategoria');
        const filterStatusEstoque = document.getElementById('filterStatusEstoque');
        const filterVendasDate = document.getElementById('filterVendasDate');

        // --- Funções da API (Simuladas) ---
        const api = {
            getProdutos: async () => { console.log('API: GET Produtos'); return { list: [...mockProdutos] }; },
            getVendas: async () => { console.log('API: GET Vendas'); return { list: [...mockVendas] }; },
            patchProduto: async (id, data) => {
                console.log('API: PATCH Produto', id, data);
                const index = mockProdutos.findIndex(p => p.Id === id);
                if (index > -1) {
                    mockProdutos[index] = { ...mockProdutos[index], ...data };
                    return mockProdutos[index];
                }
                throw new Error("Produto não encontrado.");
            },
            deleteProduto: async (id) => {
                console.log('API: DELETE Produto', id);
                mockProdutos = mockProdutos.filter(p => p.Id !== id);
                return { success: true };
            },
            postVenda: async (data) => {
                console.log('API: POST Venda', data);
                const novaVenda = { ...data, Id: nextVendaId++ };
                mockVendas.push(novaVenda);
                return novaVenda;
            }
        };

        // --- Funções Utilitárias ---
        const formatDate = (isoDate) => new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short', timeStyle: 'short' }).format(new Date(isoDate));
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

        const getStockStatus = (estoque) => {
            if (estoque === 0) return { key: 'out', text: 'Esgotado', class: 'stock-status-out' };
            if (estoque <= LOW_STOCK_THRESHOLD) return { key: 'low', text: 'Estoque Baixo', class: 'stock-status-low' };
            return { key: 'ok', text: 'Em Estoque', class: 'stock-status-ok' };
        };

        // --- Lógica de Renderização ---
        function renderEstoqueView(produtos) {
            estoqueList.innerHTML = '';
            if (produtos.length === 0) {
                estoqueList.innerHTML = `<tr><td colspan="6" class="p-4 text-center">Nenhum produto encontrado.</td></tr>`;
                return;
            }
            produtos.forEach(p => {
                const status = getStockStatus(p.estoque);
                const row = document.createElement('tr');
                row.className = "border-b";
                row.style.borderColor = 'var(--border-color)';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">${p.nome}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm" style="color: var(--text-secondary);">${p.categoria}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm" style="color: var(--text-secondary);">${formatCurrency(p.preco)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-center" style="color: var(--text-secondary);">${p.estoque}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <span class="stock-status ${status.class}">
                            <span class="status-dot" style="background-color: currentColor;"></span>
                            ${status.text}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">
                       <div class="flex items-center justify-center gap-2">
                            <button class="action-btn edit-btn" data-item='${JSON.stringify(p)}' title="Editar"><svg class="pointer-events-none text-blue-500" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V12h2.293z"/></svg></button>
                            <button class="action-btn delete-btn" data-id="${p.Id}" title="Apagar"><svg class="pointer-events-none text-red-500" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button>
                       </div>
                    </td>`;
                estoqueList.appendChild(row);
            });
        }
        
        function renderVendasView(vendas) {
            vendasList.innerHTML = '';
            if (vendas.length === 0) {
                vendasList.innerHTML = `<tr><td colspan="4" class="p-4 text-center">Nenhuma venda encontrada.</td></tr>`;
                return;
            }
            // Ordenar vendas da mais recente para a mais antiga
            vendas.sort((a, b) => new Date(b.data) - new Date(a.data)).forEach(v => {
                 const row = document.createElement('tr');
                row.className = "border-b";
                row.style.borderColor = 'var(--border-color)';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">${formatDate(v.data)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm" style="color: var(--text-secondary);">${v.produtoNome}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-center" style="color: var(--text-secondary);">${v.quantidade}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm" style="color: var(--text-secondary);">${formatCurrency(v.total)}</td>
                `;
                vendasList.appendChild(row);
            });
        }

        // --- Lógica de Filtros e Visualização ---
        function applyFiltersAndRender() {
            if (currentView === 'estoque') {
                let filteredProdutos = [...allProdutos];
                if (filterCategoria.value !== 'todos') {
                    filteredProdutos = filteredProdutos.filter(p => p.categoria === filterCategoria.value);
                }
                if (filterStatusEstoque.value !== 'todos') {
                    filteredProdutos = filteredProdutos.filter(p => getStockStatus(p.estoque).key === filterStatusEstoque.value);
                }
                renderEstoqueView(filteredProdutos);
            } else { // view === 'vendas'
                let filteredVendas = [...allVendas];
                if (filterVendasDate.value) {
                    const selectedDate = filterVendasDate.value;
                    filteredVendas = filteredVendas.filter(v => v.data.startsWith(selectedDate));
                }
                renderVendasView(filteredVendas);
            }
        }
        
        function populateFiltersAndForms() {
            // Categoria filter
            const categorias = [...new Set(allProdutos.map(p => p.categoria))];
            filterCategoria.innerHTML = '<option value="todos">Todas Categorias</option>';
            categorias.forEach(c => filterCategoria.innerHTML += `<option value="${c}">${c}</option>`);
            
            // Sales form product select
            saleProductSelect.innerHTML = '<option value="" disabled selected>Selecione um produto</option>';
            allProdutos
              .filter(p => p.estoque > 0)
              .forEach(p => {
                saleProductSelect.innerHTML += `<option value="${p.Id}">${p.nome} (Estoque: ${p.estoque})</option>`;
            });
        }
        
        // --- Funções de Carregamento de Dados ---
        async function loadData() {
            estoqueList.innerHTML = `<tr><td colspan="6" class="p-4 text-center">Carregando dados...</td></tr>`;
            try {
                const [produtosRes, vendasRes] = await Promise.all([api.getProdutos(), api.getVendas()]);
                allProdutos = produtosRes.list || [];
                allVendas = vendasRes.list || [];
                
                populateFiltersAndForms();
                applyFiltersAndRender();
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                estoqueList.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Falha ao carregar dados.</td></tr>`;
            }
        }

        // --- Gerenciamento de Eventos ---
        
        // Trocar de Visualização
        function switchView(viewName) {
            currentView = viewName;
            const isEstoque = viewName === 'estoque';
            
            estoqueView.classList.toggle('hidden', !isEstoque);
            vendasView.classList.toggle('hidden', isEstoque);
            estoqueFilters.classList.toggle('hidden', !isEstoque);
            vendasFilters.classList.toggle('hidden', isEstoque);

            viewEstoqueBtn.classList.toggle('view-btn-active', isEstoque);
            viewEstoqueBtn.classList.toggle('view-btn-inactive', !isEstoque);
            viewVendasBtn.classList.toggle('view-btn-active', !isEstoque);
            viewVendasBtn.classList.toggle('view-btn-inactive', isEstoque);
            
            applyFiltersAndRender();
        }
        viewEstoqueBtn.addEventListener('click', () => switchView('estoque'));
        viewVendasBtn.addEventListener('click', () => switchView('vendas'));
        
        // Ações da Tabela de Estoque
        estoqueList.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            
            if (button.classList.contains('delete-btn')) {
                confirmDelete.dataset.id = button.dataset.id;
                deleteModal.classList.remove('hidden');
            } else if (button.classList.contains('edit-btn')) {
                const itemData = JSON.parse(button.dataset.item);
                editForm.id.value = itemData.Id;
                editForm.nome.value = itemData.nome;
                editForm.categoria.value = itemData.categoria;
                editForm.preco.value = itemData.preco;
                editForm.estoque.value = itemData.estoque;
                editModal.classList.remove('hidden');
            }
        });

        // Submissão do Formulário de Edição
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = parseInt(editForm.id.value);
            const data = {
                nome: editForm.nome.value,
                categoria: editForm.categoria.value,
                preco: parseFloat(editForm.preco.value),
                estoque: parseInt(editForm.estoque.value),
            };
            
            try {
                await api.patchProduto(id, data);
                editModal.classList.add('hidden');
                await loadData(); // Recarrega tudo para refletir as mudanças
            } catch (error) {
                console.error("Erro ao salvar produto:", error);
                alert("Falha ao salvar produto.");
            }
        });
        
        // Confirmação de Exclusão
        confirmDelete.addEventListener('click', async () => {
            const id = parseInt(confirmDelete.dataset.id);
            try {
                await api.deleteProduto(id);
                deleteModal.classList.add('hidden');
                await loadData();
            } catch (error) {
                console.error("Erro ao apagar produto:", error);
                alert("Falha ao apagar produto.");
            }
        });

        // Submissão do Formulário de Venda
        salesForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = parseInt(salesForm.produto.value);
            const quantidade = parseInt(salesForm.quantidade.value);
            
            const produto = allProdutos.find(p => p.Id === productId);
            if (!produto) {
                alert("Produto inválido!");
                return;
            }
            if (quantidade > produto.estoque) {
                alert(`Estoque insuficiente! Apenas ${produto.estoque} unidades disponíveis.`);
                return;
            }

            const vendaData = {
                produtoId: produto.Id,
                produtoNome: produto.nome,
                quantidade: quantidade,
                total: quantidade * produto.preco,
                data: new Date().toISOString()
            };
            const estoqueAtualizado = { estoque: produto.estoque - quantidade };

            try {
                await Promise.all([
                    api.postVenda(vendaData),
                    api.patchProduto(produto.Id, estoqueAtualizado)
                ]);
                
                saleFeedback.textContent = `Venda de ${quantidade}x ${produto.nome} registrada com sucesso!`;
                saleFeedback.style.color = 'green';
                setTimeout(() => saleFeedback.textContent = '', 3000);
                
                salesForm.reset();
                await loadData();
            } catch (error) {
                 console.error("Erro ao registrar venda:", error);
                 alert("Falha ao registrar venda.");
            }
        });

        // Filtros
        [filterCategoria, filterStatusEstoque, filterVendasDate].forEach(el => el.addEventListener('change', applyFiltersAndRender));

        // Botões de Modal e Refresh
        cancelEdit.addEventListener('click', () => editModal.classList.add('hidden'));
        cancelDelete.addEventListener('click', () => deleteModal.classList.add('hidden'));
        refreshButton.addEventListener('click', loadData);

        // --- Gerenciamento de Tema ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-theme');
                document.documentElement.classList.remove('light-theme');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark-theme');
                document.documentElement.classList.add('light-theme');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            localStorage.setItem('theme', theme);
        };

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        });

        // --- Carga Inicial ---
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        loadData();
    </script>
</body>
</html>
