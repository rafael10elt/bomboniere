<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi Doces - Sistema de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117; --bg-secondary: #161b22; --glass-bg: rgba(22, 27, 34, 0.6);
            --text-primary: #e2e8f0; --text-secondary: #9ca3af; --text-title: #3b82f6;
            --border-color: rgba(255, 255, 255, 0.1); --input-bg: #1e293b; --input-border: #334155;
            --btn-bg: #1e293b; --btn-border: #334155; --btn-hover-bg: #334155;
            --accent-orange: #ff6b35; --electric-blue: #00d4ff; --dark-overlay: rgba(10, 25, 47, 0.9);
            
        }
        .light-theme {
            --bg-primary: #f1f5f9; --bg-secondary: #ffffff; --glass-bg: rgba(255, 255, 255, 0.7);
            --text-primary: #0f172a; --text-secondary: #475569; --text-title: #1d4ed8;
            --border-color: #e2e8f0; --input-bg: #ffffff; --input-border: #cbd5e1;
            --btn-bg: #f1f5f9; --btn-border: #cbd5e1; --btn-hover-bg: #e2e8f0;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .logo-symbol { width: 50px; height: 50px; background: linear-gradient(135deg, var(--dark-overlay), var(--dark-overlay)); border-radius: 10px; margin-right: 15px; display: flex; align-items: center; justify-content: center; position: relative; animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 20px var(--accent-orange); } to { box-shadow: 0 0 30px var(--electric-blue), 0 0 40px var(--electric-blue); } }
        .glass-effect { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        .glow-text { text-shadow: 0 0 5px rgba(59, 130, 246, 0.5), 0 0 10px rgba(59, 130, 246, 0.5); }
        .light-theme .glow-text { text-shadow: none; }
        .action-btn { background: transparent; border: none; cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s; color: var(--text-secondary); }
        .action-btn:hover { background-color: rgba(127, 127, 127, 0.1); }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--bg-primary); } ::-webkit-scrollbar-thumb { background: #2d3748; border-radius: 4px; } .light-theme ::-webkit-scrollbar-thumb { background: #cbd5e1; }
        .custom-input, .custom-select { background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        .light-theme .custom-input, .light-theme .custom-select { color: var(--text-primary); }
        .light-theme .custom-input option, .light-theme .custom-select option { background-color: white; color: black; }
        .custom-input::placeholder { color: var(--text-secondary); }
        .page-btn { color: var(--text-secondary); background-color: transparent; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: all 0.2s; font-weight: 500; }
        .page-btn:hover { background-color: var(--btn-hover-bg); }
        .page-btn-active { background-color: var(--text-title); color: white; box-shadow: 0 2px 10px -2px var(--text-title); }
        .stock-status { padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .stock-status-ok, .payment-status-pago { background-color: #166534; color: #dcfce7; } .stock-status-low, .payment-status-pendente { background-color: #854d0e; color: #fef9c3; } .stock-status-out { background-color: #991b1b; color: #fee2e2; }
        .light-theme .stock-status-ok, .light-theme .payment-status-pago { background-color: #dcfce7; color: #166534; } .light-theme .stock-status-low, .light-theme .payment-status-pendente { background-color: #fef9c3; color: #854d0e; } .light-theme .stock-status-out { background-color: #fee2e2; color: #991b1b; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .payment-btn-group button { border: 1px solid var(--input-border); padding: 8px 12px; transition: background-color 0.2s; }
        .payment-btn-group button.selected { background-color: var(--text-title); color: white; border-color: var(--text-title); }
        .modal-label { color: var(--text-secondary); } .light-theme .modal-label { color: var(--text-primary); }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .search-results-option { background-color: var(--input-bg); } .light-theme .search-results-option { background-color: var(--bg-secondary); }
        #salesFilterButtons button.filter-btn-active, #pendentesFilterButtons button.filter-btn-active { background-color: var(--text-title); color: white; }
    </style>
</head>
<body class="min-h-screen">
    <div id="loginPage" class="flex items-center justify-center min-h-screen">
        <div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <div class="flex items-center justify-center gap-4 mb-8">
                <div class="logo-symbol">
                    <img src="LogoLumi.png" alt="Logo Lumitech" style="width: 38px; height: 38px; object-fit: contain; position: absolute; left: 6px; top: 6px; z-index: 2; pointer-events: none;" />
                </div>
                <h1 class="text-3xl font-bold font-orbitron glow-text">Lumi Doces</h1>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="modal-label block text-sm font-medium">Usuário</label>
                    <input type="text" id="username" class="custom-input mt-1" placeholder="admin" value="admin">
                </div>
                <div>
                    <label for="password" class="modal-label block text-sm font-medium">Senha</label>
                    <input type="password" id="password" class="custom-input mt-1" placeholder="••••••••" value="Lumi10">
                </div>
                <button type="submit" class="w-full justify-center py-2 px-4 border-transparent rounded-md text-white bg-blue-600 hover:bg-blue-700">Entrar</button>
            </form>
        </div>
    </div>

    <div id="app-wrapper" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 max-w-full">
        <header class="flex items-center justify-between gap-4 mb-6 pt-4 sm:pt-6">
            <div class="flex items-center gap-4">
                <div class="logo-symbol"><img src="LogoLumi.png" alt="Logo Lumitech" style="width: 38px; height: 38px; object-fit: contain; position: absolute; left: 6px; top: 6px; z-index: 2; pointer-events: none;" /></div>
                <h1 class="text-3xl sm:text-4xl font-bold font-orbitron glow-text">Lumi Doces</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="currentUserDisplay" class="text-sm text-gray-400"></span>
                <button id="themeToggleBtn" class="action-btn p-2 rounded-full" title="Alternar tema"><svg id="theme-icon-sun" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><svg id="theme-icon-moon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button>
                <button id="logoutBtn" class="action-btn p-2 rounded-full" title="Sair">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/>
                        <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
                    </svg>
                </button>
            </div>
        </header>

        <nav class="mb-8 p-2 glass-effect rounded-lg flex items-center justify-center sm:justify-start gap-2 flex-wrap">
            <button id="pageVendasBtn" class="page-btn page-btn-active">Vendas</button>
            <button id="pageEstoqueBtn" class="page-btn">Estoque</button>
            <button id="pageCustosBtn" class="page-btn hidden">Custos</button>
            <button id="pageDashboardBtn" class="page-btn hidden">Dashboard</button>
            <button id="pageGestaoBtn" class="page-btn hidden">Gestão</button>
        </nav>

        <main id="app-content">
            <!-- PÁGINA DASHBOARD -->
            <div id="dashboardPage" class="hidden">
                 <div class="glass-effect p-4 rounded-lg mb-8 flex flex-col sm:flex-row items-center gap-4 justify-between flex-wrap">
                     <div class="w-full sm:w-auto flex flex-col sm:flex-row gap-4 items-center">
                         <div class="flex items-center gap-2 w-full"><label for="dashboardFilterStartDate" class="text-sm">De:</label><input type="date" id="dashboardFilterStartDate" class="custom-input w-full"></div>
                         <div class="flex items-center gap-2 w-full"><label for="dashboardFilterEndDate" class="text-sm">Até:</label><input type="date" id="dashboardFilterEndDate" class="custom-input w-full"></div>
                     </div>
                     <div class="flex items-center gap-2">
                         <div id="salesFilterButtons" class="flex items-center gap-2 rounded-md p-1" style="background-color: var(--btn-bg);"><button data-period="week" class="px-3 py-1 text-sm rounded-md">Semana</button><button data-period="month" class="px-3 py-1 text-sm rounded-md">Mês</button><button data-period="year" class="px-3 py-1 text-sm rounded-md">Ano</button></div>
                          <button id="generateReportBtn" class="bg-blue-600 text-white px-3 py-1.5 rounded-md font-semibold hover:bg-blue-700 transition">Gerar Relatório</button>
                     </div>
                 </div>

                 <!-- SEÇÃO BALANÇO -->
                 <h2 class="text-2xl font-semibold mb-4 font-orbitron">Balanço Financeiro</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                     <div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-400">RECEITA BRUTA</h3><p id="balancoReceita" class="text-2xl font-bold"></p></div>
                     <div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-400">CUSTO TOTAL</h3><p id="balancoCustos" class="text-2xl font-bold"></p></div>
                     <div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-green-400">LUCRO BRUTO</h3><p id="balancoLucro" class="text-2xl font-bold"></p></div>
                     <div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-yellow-400">CUSTOS PENDENTES</h3><p id="balancoPendente" class="text-2xl font-bold"></p></div>
                     <div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-blue-400">MARGEM DE LUCRO</h3><p id="balancoMargem" class="text-2xl font-bold"></p></div>
                 </div>
                 <div class="grid grid-cols-1 gap-8 mb-8">
                      <div class="glass-effect p-6 rounded-lg"><h3 class="font-semibold mb-4 text-center">Faturamento e Custos Mensais (Últimos 12 Meses)</h3><div class="chart-container"><canvas id="revenueVsCostsChart"></canvas></div></div>
                 </div>
                 
                 <!-- SEÇÃO VENDAS -->
                 <h2 class="text-2xl font-semibold mb-4 font-orbitron mt-12">Análise de Vendas</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                     <div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-400">VENDAS REALIZADAS</h3><p id="metricTotalSales" class="text-2xl font-bold"></p></div>
                     <div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-400">ITENS VENDIDOS</h3><p id="metricItemsSold" class="text-2xl font-bold"></p></div>
                     <div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-gray-400">TICKET MÉDIO</h3><p id="metricAvgTicket" class="text-2xl font-bold"></p></div>
                      <div class="glass-effect p-4 rounded-lg"><h3 class="text-sm font-semibold text-red-400">VENDAS CANCELADAS</h3><p id="metricCancelledSales" class="text-2xl font-bold"></p></div>
                 </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="glass-effect p-6 rounded-lg">
                        <h3 class="font-semibold mb-4 text-center">Vendas por Dia da Semana</h3>
                        <div class="chart-container"><canvas id="salesByWeekdayChart"></canvas></div>
                    </div>
                    <div class="glass-effect p-6 rounded-lg">
                        <h3 class="font-semibold mb-4 text-center">Vendas por Pagamento</h3>
                        <div class="chart-container"><canvas id="paymentMethodChart"></canvas></div>
                    </div>
                </div>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                      <div class="glass-effect p-6 rounded-lg"><h3 class="font-semibold mb-4 text-center">Faturamento por Categoria</h3><div class="chart-container"><canvas id="categorySalesChart"></canvas></div></div>
                      <div class="glass-effect p-6 rounded-lg"><h3 class="font-semibold mb-4 text-center">Top 5 Produtos (Faturamento)</h3><div class="chart-container"><canvas id="topProductsChart"></canvas></div></div>
                 </div>
                
                 <!-- SEÇÃO CUSTOS -->
                 <h2 class="text-2xl font-semibold mb-4 font-orbitron mt-12">Análise de Custos</h2>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="glass-effect p-6 rounded-lg"><h3 class="font-semibold mb-4 text-center">Custos por Categoria</h3><div class="chart-container"><canvas id="costsByCategoryChart"></canvas></div></div>
                    <div class="glass-effect p-6 rounded-lg"><h3 class="font-semibold mb-4 text-center">Custos por Status de Pagamento</h3><div class="chart-container"><canvas id="costsByPaymentStatusChart"></canvas></div></div>
                 </div>
                 <div class="grid grid-cols-1 gap-8 mb-8">
                    <div class="glass-effect p-6 rounded-lg"><h3 class="font-semibold mb-4 text-center">Custos por Fornecedor</h3><div class="chart-container"><canvas id="costsBySupplierChart"></canvas></div></div>
                 </div>
            </div>

            <!-- PÁGINA ESTOQUE -->
            <div id="estoquePage" class="hidden">
                <div class="glass-effect p-4 sm:p-6 rounded-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-5 gap-4 flex-wrap">
                        <div class="flex flex-col sm:flex-row sm:flex-wrap items-center gap-2 w-full flex-grow">
                            <input type="search" id="searchProdutoInput" placeholder="Pesquisar produto..." class="custom-input sm:w-auto flex-grow">
                            <select id="filterCategoria" class="custom-select sm:w-auto flex-grow-0"><option value="todos">Todas Categorias</option></select>
                            <select id="filterStatusEstoque" class="custom-select sm:w-auto flex-grow-0"><option value="todos">Todos Status</option><option value="ok">Em Estoque</option><option value="low">Estoque Baixo</option><option value="out">Esgotado</option></select>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-2 w-full sm:w-auto">
                             <button id="prepareShoppingListBtn" class="w-full sm:w-auto flex-shrink-0 bg-yellow-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-yellow-700 transition">Preparar Lista</button>
                            <button id="addProdutoBtn" class="w-full sm:w-auto flex-shrink-0 bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition">Adicionar Produto</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto"><table class="min-w-full"><thead class="border-b" style="border-color: var(--border-color);"><tr><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Produto</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Marca</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Preço</th><th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">Estoque</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th><th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">Ações</th></tr></thead><tbody id="estoqueList"></tbody></table></div>
                </div>
            </div>

             <!-- PÁGINA CUSTOS -->
            <div id="custosPage" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="glass-effect rounded-lg p-6 h-full">
                            <h2 class="text-2xl font-semibold mb-5 font-orbitron" style="color: var(--text-title);">Registrar Custo</h2>
                            <form id="addCostForm" class="space-y-4">
                                <input type="hidden" id="cost-id">
                                <div><label class="modal-label block text-sm font-medium">Descrição</label><input type="text" id="cost-description" required class="custom-input mt-1"></div>
                                <div><label class="modal-label block text-sm font-medium">Categoria</label><select id="cost-category" class="custom-select mt-1"><option>Fixo</option><option>Variável</option><option>Matéria Prima</option><option>Outros</option></select></div>
                                <div><label class="modal-label block text-sm font-medium">Fornecedor</label><select id="cost-supplier" class="custom-select mt-1"><option value="">Nenhum</option></select></div>
                                <div><label class="modal-label block text-sm font-medium">Data</label><input type="date" id="cost-date" required class="custom-input mt-1"></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="modal-label block text-sm font-medium">Valor</label><input type="number" id="cost-value" step="0.01" min="0" required class="custom-input mt-1"></div>
                                    <div><label class="modal-label block text-sm font-medium">Status Pagamento</label><select id="cost-status" class="custom-select mt-1"><option>Pago</option><option>Pendente</option></select></div>
                                </div>
                                <div class="pt-2"><button type="submit" id="saveCostBtn" class="w-full justify-center py-2 px-4 border-transparent rounded-md text-sm text-white bg-blue-600 hover:bg-blue-700">Adicionar Custo</button></div>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-8">
                        <div class="glass-effect p-4 sm:p-6 rounded-lg">
                            <h2 class="text-xl font-semibold font-orbitron mb-5">Histórico de Custos</h2>
                             <div class="flex flex-col sm:flex-row gap-4 mb-5 flex-wrap">
                                <div class="flex items-center gap-2 flex-grow"><label for="filterCustoStartDate" class="text-sm flex-shrink-0">De:</label><input type="date" id="filterCustoStartDate" class="custom-input"></div>
                                <div class="flex items-center gap-2 flex-grow"><label for="filterCustoEndDate" class="text-sm flex-shrink-0">Até:</label><input type="date" id="filterCustoEndDate" class="custom-input"></div>
                                <div class="flex-grow"><select id="filterCustoFornecedor" class="custom-select w-full"><option value="todos">Todos Fornecedores</option></select></div>
                                <div class="flex-grow"><select id="filterCustoStatus" class="custom-select w-full"><option value="todos">Todos Status</option><option>Pago</option><option>Pendente</option></select></div>
                            </div>
                            <div class="overflow-x-auto"><table class="min-w-full"><thead class="border-b" style="border-color: var(--border-color);"><tr><th class="px-4 py-3 text-left text-xs font-medium uppercase">Data</th><th class="px-4 py-3 text-left text-xs font-medium uppercase">Descrição</th><th class="px-4 py-3 text-left text-xs font-medium uppercase">Fornecedor</th><th class="px-4 py-3 text-left text-xs font-medium uppercase">Valor</th><th class="px-4 py-3 text-left text-xs font-medium uppercase">Status</th><th class="px-4 py-3 text-center text-xs font-medium uppercase">Ações</th></tr></thead><tbody id="costsList"></tbody></table></div>
                        </div>

                        <div class="glass-effect p-4 sm:p-6 rounded-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold font-orbitron">Pagamentos Pendentes</h2>
                                <div id="pendentesFilterButtons" class="flex items-center gap-2 rounded-md p-1" style="background-color: var(--btn-bg);">
                                    <button data-period="all" class="px-3 py-1 text-sm rounded-md filter-btn-active">Todos</button>
                                    <button data-period="week" class="px-3 py-1 text-sm rounded-md">Semana</button>
                                    <button data-period="month" class="px-3 py-1 text-sm rounded-md">Mês</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="border-b" style="border-color: var(--border-color);">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase">Data</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase">Descrição</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase">Fornecedor</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pendentesList"></tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- PÁGINA VENDAS -->
            <div id="vendasPage">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                     <div class="lg:col-span-1"><div class="glass-effect rounded-lg p-6 h-full flex flex-col"><h2 class="text-2xl font-semibold mb-5 font-orbitron" style="color: var(--text-title);">Registrar Venda</h2><div class="flex-grow space-y-4"><div class="flex items-end gap-2"><div class="relative flex-grow"><label class="block text-sm font-medium mb-1">Produto</label><input type="text" id="sale-product-search" placeholder="Pesquisar..." class="custom-input"><div id="sale-product-results" class="absolute z-10 w-full rounded-md mt-1 hidden max-h-40 overflow-y-auto border" style="border-color: var(--input-border);"><div class="search-results-option"></div></div></div><div class="flex-shrink-0"><label class="block text-sm font-medium mb-1">Qtd.</label><input type="number" id="sale-quantity" value="1" min="1" class="custom-input w-20 text-center"></div><button id="addToCartBtn" class="bg-blue-600 p-2 rounded-md text-white hover:bg-blue-700 h-10 flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"/></svg></button></div><div id="cart" class="border-t border-b py-2 space-y-2 flex-grow overflow-y-auto max-h-72" style="border-color: var(--border-color);"><ul id="cart-items" class="space-y-2"></ul></div></div><div class="mt-auto pt-4"><div class="flex justify-between font-bold text-lg mb-4"><span>TOTAL:</span><span id="cart-total">R$ 0,00</span></div><button id="finalizeSaleBtn" class="w-full justify-center py-2 px-4 border-transparent rounded-md text-sm text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-500">Finalizar Venda</button><div id="sale-feedback" class="mt-4 text-center"></div></div></div></div>
                     <div class="lg:col-span-2"><div class="glass-effect p-4 sm:p-6 rounded-lg"><div class="flex flex-col sm:flex-row justify-between items-center mb-5 gap-4 flex-wrap"><h2 class="text-xl font-semibold font-orbitron w-full text-center sm:w-auto sm:text-left">Histórico de Vendas</h2><div class="w-full sm:w-auto flex items-center gap-2 flex-wrap justify-center"><div class="flex items-center gap-2 flex-grow sm:flex-grow-0"><label for="filterStartDate" class="text-sm flex-shrink-0">De:</label><input type="date" id="filterStartDate" class="custom-input"></div><div class="flex items-center gap-2 flex-grow sm:flex-grow-0"><label for="filterEndDate" class="text-sm flex-shrink-0">Até:</label><input type="date" id="filterEndDate" class="custom-input"></div><div class="flex gap-2"><button id="filterTodayBtn" class="px-3 py-1.5 text-sm rounded-md" style="background-color: var(--btn-bg);">Hoje</button><button id="resetFilterBtn" class="px-3 py-1.5 text-sm rounded-md" style="background-color: var(--btn-bg);">Limpar</button></div></div></div><div class="overflow-x-auto"><table class="min-w-full"><thead class="border-b" style="border-color: var(--border-color);"><tr><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Data</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Itens</th><th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">Pagamento</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Total</th><th class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">Ações</th></tr></thead><tbody id="vendasList"></tbody></table></div></div></div>
                </div>
            </div>

            <!-- PÁGINA GESTÃO -->
            <div id="gestaoPage" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Coluna de Fornecedores -->
                    <div class="glass-effect p-4 sm:p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold font-orbitron">Fornecedores</h2>
                            <button id="addFornecedorBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition">Adicionar</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="border-b" style="border-color: var(--border-color);">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Nome</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Telefone</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="fornecedoresList"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Coluna de Funcionários -->
                    <div class="glass-effect p-4 sm:p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold font-orbitron">Funcionários</h2>
                            <button id="addFuncionarioBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition">Adicionar</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="border-b" style="border-color: var(--border-color);">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Nome</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase">Cargo</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="funcionariosList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAIS -->
    <div id="addEditModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 id="modalTitle" class="text-2xl font-semibold mb-5 font-orbitron" style="color: var(--text-title);"></h2><form id="addEditForm" class="space-y-4"><input type="hidden" id="edit-id"><div><label class="modal-label block text-sm font-medium">Nome do Produto</label><input type="text" id="edit-nome" required class="custom-input mt-1"></div><div class="grid grid-cols-2 gap-4"><div><label class="modal-label block text-sm font-medium">Marca</label><div class="relative"><input type="text" id="edit-marca" required class="custom-input mt-1"><div id="edit-marca-options" class="absolute z-10 w-full bg-gray-800 border border-gray-600 rounded-md mt-1 hidden max-h-40 overflow-y-auto"></div></div></div><div><label class="modal-label block text-sm font-medium">Categoria</label><div class="relative"><input type="text" id="edit-categoria" required class="custom-input mt-1"><div id="edit-categoria-options" class="absolute z-10 w-full bg-gray-800 border border-gray-600 rounded-md mt-1 hidden max-h-40 overflow-y-auto"></div></div></div></div><div class="grid grid-cols-2 gap-4"><div><label class="modal-label block text-sm font-medium">Preço</label><input type="number" id="edit-preco" required step="0.01" min="0" class="custom-input mt-1"></div><div><label class="modal-label block text-sm font-medium">Estoque Mínimo</label><input type="number" id="edit-estoqueMinimo" required step="1" min="0" class="custom-input mt-1"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="modal-label block text-sm font-medium">Estoque Atual</label><input type="number" id="edit-estoque" required step="1" min="0" class="custom-input mt-1"></div><div><label class="modal-label block text-sm font-medium">Unidade</label><select id="edit-unidade" class="custom-select mt-1"><option>Unidade</option><option>Caixa</option><option>Pacote</option><option>Kg</option></select></div></div><div class="flex gap-4 pt-4"><button type="button" id="cancelEdit" class="w-full justify-center py-2 px-4 border rounded-md shadow-sm text-sm" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="submit" class="w-full justify-center py-2 px-4 border-transparent rounded-md shadow-sm text-sm text-white bg-blue-600 hover:bg-blue-700">Salvar</button></div></form></div></div>
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-md text-center"><h2 class="text-2xl font-semibold mb-5 text-yellow-400 font-orbitron">Confirmar Exclusão</h2><p class="mb-6">Tem certeza de que deseja apagar este item?</p><div class="flex gap-4 pt-4"><button type="button" id="cancelDelete" class="w-full justify-center py-2 px-4 border rounded-md shadow-sm text-sm" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="button" id="confirmDelete" class="w-full justify-center py-2 px-4 border-transparent rounded-md shadow-sm text-sm text-white bg-red-600 hover:bg-red-700">Apagar</button></div></div></div>
    <div id="restockModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-sm"><h2 class="text-2xl font-semibold mb-2 font-orbitron" style="color: var(--text-title);">Repor Estoque</h2><p id="restockProductName" class="mb-4 text-gray-400"></p><form id="restockForm"><input type="hidden" id="restock-id"><label class="modal-label block text-sm font-medium">Quantidade a adicionar</label><input type="number" id="restock-quantity" min="1" required class="custom-input mt-1"><div class="flex gap-4 pt-4"><button type="button" id="cancelRestock" class="w-full justify-center py-2 px-4 border rounded-md text-sm" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="submit" class="w-full justify-center py-2 px-4 border-transparent rounded-md text-sm text-white bg-blue-600 hover:bg-blue-700">Confirmar</button></div></form></div></div>
    <div id="shoppingListModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-2xl flex flex-col h-full max-h-[90vh]"><h2 class="text-2xl font-semibold mb-4 font-orbitron text-center" style="color: var(--text-title);">Preparar Lista de Compras</h2><div class="flex-grow overflow-y-auto pr-2"><ul id="editableShoppingList" class="space-y-2"></ul></div><div class="pt-4 border-t" style="border-color: var(--border-color);"><h3 class="font-semibold mb-2">Adicionar Item</h3><form id="addShoppingItemForm" class="grid grid-cols-1 md:grid-cols-2 gap-2 items-end"><div class="relative"><label class="modal-label text-xs">Buscar Item Cadastrado</label><input type="text" id="shopping-item-search" placeholder="Pesquisar ou digitar novo item..." class="custom-input w-full"><div id="shopping-item-results" class="absolute z-20 w-full rounded-md mt-1 hidden max-h-40 overflow-y-auto border" style="border-color: var(--input-border);"></div></div><div class="flex items-end gap-2"><div class="flex-grow"><label class="modal-label text-xs">Qtd.</label><input type="number" id="shopping-item-qty" value="1" min="1" class="custom-input"></div><button type="submit" class="bg-blue-600 p-2 rounded-md text-white hover:bg-blue-700 h-10">Adicionar</button></div></form></div><div class="flex gap-4 pt-6 mt-auto"><button type="button" id="closeShoppingListModal" class="w-full justify-center py-2 px-4 border rounded-md" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Fechar</button><button type="button" id="exportShoppingListPdfBtn" class="w-full justify-center py-2 px-4 border-transparent rounded-md text-white bg-green-600 hover:bg-green-700">Salvar e Exportar PDF</button></div></div></div>
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-lg"><h2 class="text-2xl font-semibold mb-2 font-orbitron" style="color: var(--text-title);">Pagamento</h2><div class="flex justify-between items-baseline mb-4"><span class="text-lg">Total: <span id="paymentTotal"></span></span><span class="text-lg font-bold text-red-400">Restante: <span id="paymentRemaining"></span></span></div><div id="payments-made-list" class="mb-4 space-y-2 text-sm"></div><form id="addPaymentForm" class="flex items-end gap-2"><div class="flex-grow"><label class="modal-label text-xs">Valor</label><input type="number" id="payment-amount" step="0.01" min="0" class="custom-input" required></div><div><label class="modal-label text-xs">Forma</label><select id="payment-method" class="custom-select"><option>Dinheiro</option><option>Crédito</option><option>Débito</option><option>Pix</option></select></div><button type="submit" class="bg-blue-600 p-2 rounded-md text-white hover:bg-blue-700 h-10">Adicionar</button></form><div class="text-lg mt-4 font-bold text-green-400 hidden">Troco: <span id="paymentChange">R$ 0,00</span></div><div class="flex gap-4 pt-6 mt-auto"><button type="button" id="cancelPayment" class="w-full justify-center py-2 px-4 border rounded-md" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="button" id="confirmPaymentBtn" class="w-full justify-center py-2 px-4 border-transparent rounded-md text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-500" disabled>Finalizar Venda</button></div></div></div>
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-sm"><h2 class="text-2xl font-semibold mb-4 font-orbitron" style="color: var(--text-title);">Acesso Restrito</h2><p class="text-sm mb-4">Digite a senha de administrador(Lumi10).</p><form id="passwordForm"><input type="password" id="passwordInput" class="custom-input w-full"><p id="passwordError" class="text-red-500 text-xs mt-1 h-4"></p><div class="flex gap-4 pt-4"><button type="button" id="cancelPassword" class="w-full justify-center py-2 px-4 border rounded-md" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="submit" class="w-full justify-center py-2 px-4 border-transparent rounded-md text-white bg-blue-600 hover:bg-blue-700">Entrar</button></div></form></div></div>
    <div id="saleDetailsModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-lg"><h2 class="text-2xl font-semibold mb-4 font-orbitron" style="color: var(--text-title);">Detalhes da Venda</h2><div id="saleDetailsContent" class="space-y-4 text-sm"></div><div class="flex justify-end pt-6 mt-auto"><button type="button" id="closeSaleDetailsModal" class="w-full sm:w-auto justify-center py-2 px-4 border rounded-md" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Fechar</button></div></div></div>
    <div id="confirmCancelModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-md text-center"><h2 class="text-2xl font-semibold mb-5 text-yellow-400 font-orbitron">Cancelar Venda</h2><p class="mb-6">Tem certeza que deseja cancelar esta venda? Os itens retornarão ao estoque.</p><div class="flex gap-4 pt-4"><button type="button" id="cancelCancellation" class="w-full justify-center py-2 px-4 border rounded-md" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Não</button><button type="button" id="confirmCancellation" class="w-full justify-center py-2 px-4 border-transparent rounded-md text-white bg-red-600 hover:bg-red-700">Sim, Cancelar</button></div></div></div>
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-lg"><h2 class="text-2xl font-semibold mb-5 font-orbitron" style="color: var(--text-title);">Gerar Relatório</h2><form id="reportForm" class="space-y-4"><div><label class="modal-label block text-sm font-medium">Tipo de Relatório</label><select id="reportType" class="custom-select mt-1"><option value="geral">Geral (Balanço)</option><option value="vendas">Vendas</option><option value="custos">Custos</option></select></div><div class="grid grid-cols-2 gap-4"><div><label class="modal-label block text-sm font-medium">Data Inicial</label><input type="date" id="reportStartDate" class="custom-input mt-1" required></div><div><label class="modal-label block text-sm font-medium">Data Final</label><input type="date" id="reportEndDate" class="custom-input mt-1" required></div></div><div class="flex gap-4 pt-4"><button type="button" id="cancelReport" class="w-full justify-center py-2 px-4 border rounded-md" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="submit" class="w-full justify-center py-2 px-4 border-transparent rounded-md text-white bg-blue-600 hover:bg-blue-700">Gerar PDF</button></div></form></div></div>
    <div id="logoutModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-md text-center"><h2 class="text-2xl font-semibold mb-5 font-orbitron">Sair do Sistema</h2><p class="mb-6">Tem certeza de que deseja sair?</p><div class="flex gap-4 pt-4"><button type="button" id="cancelLogout" class="w-full justify-center py-2 px-4 border rounded-md shadow-sm text-sm" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="button" id="confirmLogout" class="w-full justify-center py-2 px-4 border-transparent rounded-md shadow-sm text-sm text-white bg-red-600 hover:bg-red-700">Sair</button></div></div></div>
    <div id="fornecedorModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 id="fornecedorModalTitle" class="text-2xl font-semibold mb-5 font-orbitron" style="color: var(--text-title);"></h2><form id="fornecedorForm" class="space-y-4"><input type="hidden" id="fornecedor-id"><div><label class="modal-label block text-sm font-medium">Nome do Fornecedor</label><input type="text" id="fornecedor-nome" required class="custom-input mt-1"></div><div><label class="modal-label block text-sm font-medium">Contato (Nome)</label><input type="text" id="fornecedor-contato" class="custom-input mt-1"></div><div><label class="modal-label block text-sm font-medium">Telefone (com DDD)</label><input type="tel" id="fornecedor-telefone" required class="custom-input mt-1" placeholder="11987654321"></div><div><label class="modal-label block text-sm font-medium">Categoria</label><input type="text" id="fornecedor-categoria" class="custom-input mt-1"></div><div class="flex gap-4 pt-4"><button type="button" id="cancelFornecedor" class="w-full justify-center py-2 px-4 border rounded-md shadow-sm text-sm" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="submit" class="w-full justify-center py-2 px-4 border-transparent rounded-md shadow-sm text-sm text-white bg-blue-600 hover:bg-blue-700">Salvar</button></div></form></div></div>
    <div id="funcionarioModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50 p-4"><div class="glass-effect p-8 rounded-lg shadow-2xl w-full max-w-md"><h2 id="funcionarioModalTitle" class="text-2xl font-semibold mb-5 font-orbitron" style="color: var(--text-title);"></h2><form id="funcionarioForm" class="space-y-4"><input type="hidden" id="funcionario-id"><div><label class="modal-label block text-sm font-medium">Nome do Funcionário</label><input type="text" id="funcionario-nome" required class="custom-input mt-1"></div><div><label class="modal-label block text-sm font-medium">Cargo</label><select id="funcionario-cargo" class="custom-select mt-1"><option>Vendedor(a)</option><option>Gerente</option></select></div><div><label class="modal-label block text-sm font-medium">Telefone (com DDD)</label><input type="tel" id="funcionario-telefone" class="custom-input mt-1" placeholder="83987654321"></div><div class="grid grid-cols-2 gap-4"><div><label class="modal-label block text-sm font-medium">Login</label><input type="text" id="funcionario-login" required class="custom-input mt-1"></div><div><label class="modal-label block text-sm font-medium">Senha</label><input type="password" id="funcionario-senha" required class="custom-input mt-1"></div></div><div class="flex items-center"><input id="funcionario-admin" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-transparent"><label for="funcionario-admin" class="ml-2 block text-sm text-gray-400">Administrador</label></div><div class="flex gap-4 pt-4"><button type="button" id="cancelFuncionario" class="w-full justify-center py-2 px-4 border rounded-md shadow-sm text-sm" style="border-color: var(--input-border); color: var(--text-primary); background-color: var(--btn-bg);">Cancelar</button><button type="submit" class="w-full justify-center py-2 px-4 border-transparent rounded-md shadow-sm text-sm text-white bg-blue-600 hover:bg-blue-700">Salvar</button></div></form></div></div>
    
    <script type="module">
        const { jsPDF } = window.jspdf;
        // --- DADOS DE DEMONSTRAÇÃO ---
        let mockProdutos = [ { Id: 1, nome: 'Brigadeiro Gourmet', categoria: 'Doces', marca: 'Lumi', unidade: 'Unidade', preco: 4.50, estoque: 50, estoqueMinimo: 10 }, { Id: 2, nome: 'Caixa de Bombom', categoria: 'Chocolates', marca: 'Nestlé', unidade: 'Caixa', preco: 25.00, estoque: 8, estoqueMinimo: 5 }, { Id: 3, nome: 'Bala de Goma (100g)', categoria: 'Balas', marca: 'Fini', unidade: 'Pacote', preco: 6.00, estoque: 80, estoqueMinimo: 20 }, { Id: 4, nome: 'Pirulito Colorido', categoria: 'Balas', marca: 'Lumi', unidade: 'Unidade', preco: 1.50, estoque: 120, estoqueMinimo: 50 }, { Id: 5, nome: 'Barra de Chocolate Amargo', categoria: 'Chocolates', marca: 'Cacau Show', unidade: 'Unidade', preco: 12.00, estoque: 0, estoqueMinimo: 10 }, { Id: 6, nome: 'Paçoca', categoria: 'Doces', marca: 'Santa Helena', unidade: 'Unidade', preco: 2.00, estoque: 45, estoqueMinimo: 15 }, ];
        let mockVendas = [ { Id: 101, items: [{produtoId: 3, produtoNome: "Bala de Goma (100g)", quantidade: 2, precoUnitario: 6.00}], total: 12.00, pagamentos: [{method: 'Débito', amount: 12.00}], data: '2025-07-23T10:00:00Z', edited: false, status: 'completed' }, { Id: 102, items: [{produtoId: 1, produtoNome: "Brigadeiro Gourmet", quantidade: 5, precoUnitario: 4.50}], total: 22.50, pagamentos: [{method: 'Pix', amount: 22.50}], data: '2025-08-15T14:30:00Z', edited: false, status: 'completed' }, { Id: 103, items: [{produtoId: 2, produtoNome: "Caixa de Bombom", quantidade: 1, precoUnitario: 25.00}, {produtoId: 4, produtoNome: "Pirulito Colorido", quantidade: 10, precoUnitario: 1.50}], total: 40.00, pagamentos: [{method: 'Crédito', amount: 40.00}], data: '2025-09-24T18:00:00Z', edited: false, status: 'completed' }, ];
        let mockFornecedores = [ { Id: 1, nome: "Doce Sabor Atacado", contato: "Carlos", telefone: "83999999999", categoria: "Matéria Prima" }, { Id: 2, nome: "EmbalaTudo Embalagens", contato: "Antônio", telefone: "83900000000", categoria: "Embalagens" } ];
        let mockFuncionarios = [ { Id: 1, nome: "Admin", cargo: "Gerente", telefone: "83999999999", login: "admin", senha: "Lumi10", isAdmin: true }, { Id: 2, nome: "Maria Silva", cargo: "Vendedor(a)", telefone: "83900000000", login: "msilva", senha: "123", isAdmin: false } ];
        let mockCustos = [ {Id: 1, descricao: "Aluguel Loja", categoria: "Fixo", data: "2025-09-05T00:00:00Z", valor: 1500.00, fornecedorId: null, status: 'Pago'}, {Id: 2, descricao: "Compra de Chocolate", categoria: "Matéria Prima", data: "2025-09-10T00:00:00Z", valor: 350.75, fornecedorId: 1, status: 'Pago'}, {Id: 3, descricao: "Conta de Energia", categoria: "Variável", data: "2025-09-20T00:00:00Z", valor: 280.50, fornecedorId: null, status: 'Pendente'} ];
        let nextProductId = 7, nextVendaId = 104, nextCustoId = 4, nextFornecedorId = 3, nextFuncionarioId = 3;
        
        // --- API SIMULADA ---
        const api = { 
            getProdutos: async () => ({ list: [...mockProdutos] }), patchProduto: async (id, data) => { const i = mockProdutos.findIndex(p=>p.Id===id); if(i>-1){ mockProdutos[i]={...mockProdutos[i],...data}; return mockProdutos[i]; } throw new Error("Produto não encontrado."); }, postProduto: async (data) => { const newProd = { ...data, Id: nextProductId++ }; mockProdutos.push(newProd); return newProd; }, deleteProduto: async (id) => { mockProdutos = mockProdutos.filter(p=>p.Id!==id); return { success: true }; }, 
            getVendas: async () => ({ list: [...mockVendas] }), postVenda: async (data) => { const newSale = { ...data, Id: nextVendaId++ }; mockVendas.push(newSale); return newSale; }, patchVenda: async(id, data) => { const i = mockVendas.findIndex(v=>v.Id===id); if(i>-1){ mockVendas[i]={...mockVendas[i],...data}; return mockVendas[i];} throw new Error("Venda não encontrada.")},
            getCustos: async () => ({ list: [...mockCustos] }), postCusto: async (data) => { const newCost = { ...data, Id: nextCustoId++ }; mockCustos.push(newCost); return newCost; }, patchCusto: async (id, data) => { const i = mockCustos.findIndex(c => c.Id === id); if (i > -1) { mockCustos[i] = { ...mockCustos[i], ...data }; return mockCustos[i]; } throw new Error("Custo não encontrado."); }, deleteCusto: async (id) => { mockCustos = mockCustos.filter(c => c.Id !== id); return { success: true }; },
            getFornecedores: async () => ({ list: [...mockFornecedores] }), postFornecedor: async (data) => { const d = {...data, Id: nextFornecedorId++}; mockFornecedores.push(d); return d; }, patchFornecedor: async(id, data) => { const i = mockFornecedores.findIndex(f=>f.Id===id); if(i>-1){mockFornecedores[i] = {...mockFornecedores[i], ...data}; return mockFornecedores[i];} throw new Error("Fornecedor não encontrado.")}, deleteFornecedor: async(id) => { mockFornecedores = mockFornecedores.filter(f=>f.Id!==id); return {success: true};},
            getFuncionarios: async () => ({ list: [...mockFuncionarios] }), postFuncionario: async (data) => { const d = {...data, Id: nextFuncionarioId++}; mockFuncionarios.push(d); return d; }, patchFuncionario: async(id, data) => { const i = mockFuncionarios.findIndex(f=>f.Id===id); if(i>-1){mockFuncionarios[i] = {...mockFuncionarios[i], ...data}; return mockFuncionarios[i];} throw new Error("Funcionário não encontrado.")}, deleteFuncionario: async(id) => { mockFuncionarios = mockFuncionarios.filter(f=>f.Id!==id); return {success: true};},
        };

        // --- ESTADO DA APLICAÇÃO ---
        let allProdutos = [], allVendas = [], allCustos = [], allFornecedores = [], allFuncionarios = [], currentCart = [];
        let charts = {};
        let selectedProductForSale = null;
        let saleToEditId = null;
        let actionAfterPassword = null;
        let isEditingSale = false;
        let currentPayments = [];
        let currentUser = null;

        // --- SELETORES DE UI ---
        const pageDashboardBtn = document.getElementById('pageDashboardBtn'), pageEstoqueBtn = document.getElementById('pageEstoqueBtn'), pageVendasBtn = document.getElementById('pageVendasBtn'), pageCustosBtn = document.getElementById('pageCustosBtn'), pageGestaoBtn = document.getElementById('pageGestaoBtn');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const sunIcon = document.getElementById('theme-icon-sun'), moonIcon = document.getElementById('theme-icon-moon');
        const addProdutoBtn = document.getElementById('addProdutoBtn');
        const addEditModal = document.getElementById('addEditModal'), modalTitle = document.getElementById('modalTitle'), addEditForm = document.getElementById('addEditForm'), cancelEdit = document.getElementById('cancelEdit');
        const deleteModal = document.getElementById('deleteModal'), cancelDelete = document.getElementById('cancelDelete'), confirmDelete = document.getElementById('confirmDelete');
        const restockModal = document.getElementById('restockModal'), restockForm = document.getElementById('restockForm'), cancelRestock = document.getElementById('cancelRestock');
        const shoppingListModal = document.getElementById('shoppingListModal'), editableShoppingList = document.getElementById('editableShoppingList'), addShoppingItemForm = document.getElementById('addShoppingItemForm'), closeShoppingListModal = document.getElementById('closeShoppingListModal'), exportShoppingListPdfBtn = document.getElementById('exportShoppingListPdfBtn'), prepareShoppingListBtn = document.getElementById('prepareShoppingListBtn');
        const shoppingItemSearch = document.getElementById('shopping-item-search'), shoppingItemResults = document.getElementById('shopping-item-results');
        const paymentModal = document.getElementById('paymentModal'), addPaymentForm = document.getElementById('addPaymentForm'), cancelPayment = document.getElementById('cancelPayment'), confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
        const passwordModal = document.getElementById('passwordModal'), passwordForm = document.getElementById('passwordForm'), cancelPassword = document.getElementById('cancelPassword');
        const saleDetailsModal = document.getElementById('saleDetailsModal'), closeSaleDetailsModal = document.getElementById('closeSaleDetailsModal');
        const confirmCancelModal = document.getElementById('confirmCancelModal'), cancelCancellation = document.getElementById('cancelCancellation'), confirmCancellation = document.getElementById('confirmCancellation');
        const estoqueList = document.getElementById('estoqueList'), vendasList = document.getElementById('vendasList'), costsList = document.getElementById('costsList'), fornecedoresList = document.getElementById('fornecedoresList'), funcionariosList = document.getElementById('funcionariosList');
        const addCostForm = document.getElementById('addCostForm'), saveCostBtn = document.getElementById('saveCostBtn');
        const saleProductSearchInput = document.getElementById('sale-product-search'), saleProductResults = document.getElementById('sale-product-results');
        const saleQuantityInput = document.getElementById('sale-quantity'), addToCartBtn = document.getElementById('addToCartBtn'), cartItemsList = document.getElementById('cart-items'), cartTotalEl = document.getElementById('cart-total'), finalizeSaleBtn = document.getElementById('finalizeSaleBtn');
        const saleFeedback = document.getElementById('sale-feedback');
        const filterCategoria = document.getElementById('filterCategoria'), filterStatusEstoque = document.getElementById('filterStatusEstoque'), searchProdutoInput = document.getElementById('searchProdutoInput');
        const filterStartDate = document.getElementById('filterStartDate'), filterEndDate = document.getElementById('filterEndDate');
        const filterTodayBtn = document.getElementById('filterTodayBtn'), resetFilterBtn = document.getElementById('resetFilterBtn');
        const dashboardFilterStartDate = document.getElementById('dashboardFilterStartDate'), dashboardFilterEndDate = document.getElementById('dashboardFilterEndDate');
        const generateReportBtn = document.getElementById('generateReportBtn'), reportModal = document.getElementById('reportModal'), reportForm = document.getElementById('reportForm'), cancelReport = document.getElementById('cancelReport');
        const loginPage = document.getElementById('loginPage'), appWrapper = document.getElementById('app-wrapper'), loginForm = document.getElementById('loginForm'), logoutBtn = document.getElementById('logoutBtn');
        const logoutModal = document.getElementById('logoutModal'), cancelLogout = document.getElementById('cancelLogout'), confirmLogout = document.getElementById('confirmLogout');
        const fornecedorModal = document.getElementById('fornecedorModal'), fornecedorForm = document.getElementById('fornecedorForm'), cancelFornecedor = document.getElementById('cancelFornecedor'), addFornecedorBtn = document.getElementById('addFornecedorBtn');
        const funcionarioModal = document.getElementById('funcionarioModal'), funcionarioForm = document.getElementById('funcionarioForm'), cancelFuncionario = document.getElementById('cancelFuncionario'), addFuncionarioBtn = document.getElementById('addFuncionarioBtn');
        const currentUserDisplay = document.getElementById('currentUserDisplay');
        const filterCustoStartDate = document.getElementById('filterCustoStartDate'), filterCustoEndDate = document.getElementById('filterCustoEndDate'), filterCustoFornecedor = document.getElementById('filterCustoFornecedor'), filterCustoStatus = document.getElementById('filterCustoStatus');
        const pendentesList = document.getElementById('pendentesList'), pendentesFilterButtons = document.getElementById('pendentesFilterButtons');

        // --- FUNÇÕES UTILITÁRIAS ---
        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
        const getStockStatus = (p) => p.estoque === 0 ? { k: 'out', t: 'Esgotado', c: 'stock-status-out' } : p.estoque <= p.estoqueMinimo ? { k: 'low', t: 'Estoque Baixo', c: 'stock-status-low' } : { k: 'ok', t: 'Em Estoque', c: 'stock-status-ok' };

        // --- LÓGICA DE RENDERIZAÇÃO ---
        const renderEstoqueView = (prods) => {
            estoqueList.innerHTML = prods.length ? prods.map(p => {
                const s = getStockStatus(p);
                return `<tr class="border-b" style="border-color: var(--border-color);"><td class="px-4 py-3 text-sm font-medium">${p.nome}</td><td class="px-4 py-3 text-sm text-gray-400">${p.marca}</td><td class="px-4 py-3 text-sm text-gray-400">${formatCurrency(p.preco)}</td><td class="px-4 py-3 text-sm text-center text-gray-400">${p.estoque} ${p.unidade}</td><td class="px-4 py-3 text-sm"><span class="stock-status ${s.c}"><span class="status-dot" style="background-color: currentColor;"></span>${s.t}</span></td><td class="px-4 py-3 text-center"><div class="flex items-center justify-center gap-1"><button class="action-btn restock-btn" data-id="${p.Id}" data-name="${p.nome}" title="Repor Estoque"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="pointer-events-none text-green-400" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/></svg></button><button class="action-btn edit-btn" data-item='${JSON.stringify(p)}' title="Editar"><svg class="pointer-events-none text-blue-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V12h2.293z"/></svg></button><button class="action-btn delete-btn" data-id="${p.Id}" title="Apagar"><svg class="pointer-events-none text-red-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button></div></td></tr>`;
            }).join('') : `<tr><td colspan="6" class="p-4 text-center">Nenhum produto encontrado.</td></tr>`;
        };

        const renderCustosView = (custos) => {
            costsList.innerHTML = custos.length ? custos.sort((a,b) => new Date(b.data) - new Date(a.data)).map(c => {
                const fornecedor = allFornecedores.find(f => f.Id === c.fornecedorId);
                const statusClass = c.status === 'Pago' ? 'payment-status-pago' : 'payment-status-pendente';
                const statusText = c.status || 'N/A';
                return `
                <tr class="border-b" style="border-color: var(--border-color);">
                    <td class="px-4 py-3 text-sm">${new Date(c.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${c.descricao}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${fornecedor ? fornecedor.nome : 'N/A'}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${formatCurrency(c.valor)}</td>
                    <td class="px-4 py-3 text-sm"><span class="stock-status ${statusClass}">${statusText}</span></td>
                    <td class="px-4 py-3 text-center"><div class="flex items-center justify-center gap-1">
                        <button class="action-btn edit-cost-btn" data-item='${JSON.stringify(c)}' title="Editar Custo"><svg class="pointer-events-none text-blue-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V12h2.293z"/></svg></button>
                        <button class="action-btn delete-cost-btn" data-id="${c.Id}" title="Apagar Custo"><svg class="pointer-events-none text-red-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button>
                    </div></td>
                </tr>
            `}).join('') : `<tr><td colspan="6" class="p-4 text-center">Nenhum custo encontrado.</td></tr>`;
        };
        
        const renderPendentesView = (period = 'all') => {
            let pendentes = allCustos.filter(c => c.status === 'Pendente');
            
            if (period !== 'all') {
                const endDate = new Date();
                let startDate = new Date();
                if(period === 'week') startDate.setDate(endDate.getDate() - 7);
                if(period === 'month') startDate.setMonth(endDate.getMonth() - 1);
                
                pendentes = pendentes.filter(c => {
                    const costDate = new Date(c.data);
                    return costDate >= startDate && costDate <= endDate;
                });
            }

            pendentesList.innerHTML = pendentes.length ? pendentes.sort((a,b) => new Date(a.data) - new Date(b.data)).map(c => {
                const fornecedor = allFornecedores.find(f => f.Id === c.fornecedorId);
                return `
                <tr class="border-b" style="border-color: var(--border-color);">
                    <td class="px-4 py-3 text-sm">${new Date(c.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${c.descricao}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${fornecedor ? fornecedor.nome : 'N/A'}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${formatCurrency(c.valor)}</td>
                </tr>
            `}).join('') : `<tr><td colspan="4" class="p-4 text-center">Nenhum pagamento pendente.</td></tr>`;
        };

        const renderVendasView = (vendas) => {
            vendasList.innerHTML = vendas.length ? vendas.sort((a, b) => new Date(b.data) - new Date(a.data)).map(v => {
                const isCancelled = v.status === 'cancelled';
                return `
                <tr class="border-b ${isCancelled ? 'opacity-50' : ''}" style="border-color: var(--border-color);">
                    <td class="px-4 py-3 text-sm">
                        ${new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short', timeStyle: 'short' }).format(new Date(v.data))} 
                        ${v.edited ? '<span class="text-xs text-yellow-400">(Editada)</span>' : ''}
                        ${isCancelled ? '<span class="text-xs text-red-400 font-bold">(CANCELADA)</span>' : ''}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-400 ${isCancelled ? 'line-through' : ''}">${v.items.map(i => `${i.quantidade}x ${i.produtoNome}`).join(', ')}</td>
                    <td class="px-4 py-3 text-sm text-center text-gray-400 ${isCancelled ? 'line-through' : ''}">${v.pagamentos.map(p=>p.method).join(', ')}</td>
                    <td class="px-4 py-3 text-sm text-gray-400 ${isCancelled ? 'line-through' : ''}">${formatCurrency(v.total)}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex items-center justify-center gap-1">
                             <button class="action-btn view-sale-details-btn" data-id="${v.Id}" title="Ver Detalhes">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="pointer-events-none text-gray-400" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/></svg>
                             </button>
                            ${!isCancelled ? `
                            <button class="action-btn edit-sale-btn" data-id="${v.Id}" title="Editar Venda">
                                <svg class="pointer-events-none text-blue-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V12h2.293z"/></svg>
                            </button>
                            <button class="action-btn cancel-sale-btn" data-id="${v.Id}" title="Cancelar Venda">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="pointer-events-none text-red-400" viewBox="0 0 16 16"><path d="M1.293 1.293a1 1 0 0 1 1.414 0L8 6.586l5.293-5.293a1 1 0 1 1 1.414 1.414L9.414 8l5.293 5.293a1 1 0 0 1-1.414 1.414L8 9.414l-5.293 5.293a1 1 0 0 1-1.414-1.414L6.586 8 1.293 2.707a1 1 0 0 1 0-1.414z"/></svg>
                            </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `}).join('') : `<tr><td colspan="5" class="p-4 text-center">Nenhuma venda encontrada.</td></tr>`;
        };
        
        const renderDashboard = (vendasData, produtosData, custosData) => {
            const completedVendas = vendasData.filter(v => v.status === 'completed');
            const cancelledVendas = vendasData.filter(v => v.status === 'cancelled');
            
            // Balanço
            const receitaBruta = completedVendas.reduce((s, v) => s + v.total, 0);
            const custoTotal = custosData.reduce((s, c) => s + c.valor, 0);
            const lucroBruto = receitaBruta - custoTotal;
            const margemLucro = receitaBruta > 0 ? (lucroBruto / receitaBruta) * 100 : 0;
            const custosPendentes = custosData.filter(c => c.status === 'Pendente').reduce((s, c) => s + c.valor, 0);
            document.getElementById('balancoReceita').textContent = formatCurrency(receitaBruta);
            document.getElementById('balancoCustos').textContent = formatCurrency(custoTotal);
            document.getElementById('balancoLucro').textContent = formatCurrency(lucroBruto);
            document.getElementById('balancoMargem').textContent = `${margemLucro.toFixed(2)}%`;
            document.getElementById('balancoPendente').textContent = formatCurrency(custosPendentes);

            // Vendas
            document.getElementById('metricTotalSales').textContent = completedVendas.length;
            document.getElementById('metricItemsSold').textContent = completedVendas.reduce((s, v) => s + v.items.reduce((si, i) => si + i.quantidade, 0), 0);
            document.getElementById('metricAvgTicket').textContent = completedVendas.length ? formatCurrency(receitaBruta / completedVendas.length) : formatCurrency(0);
            document.getElementById('metricCancelledSales').textContent = cancelledVendas.length;
            
            const renderChart = (id, type, data, options) => { if (charts[id]) charts[id].destroy(); const ctx = document.getElementById(id); if (ctx) { charts[id] = new Chart(ctx.getContext('2d'), { type, data, options }); }};
            
            const categoryData = completedVendas.reduce((acc, v) => { v.items.forEach(i => { const p = allProdutos.find(prod => prod.Id === i.produtoId); if (p) acc[p.categoria] = (acc[p.categoria] || 0) + (i.quantidade * i.precoUnitario); }); return acc; }, {});
            renderChart('categorySalesChart', 'doughnut', { labels: Object.keys(categoryData), datasets: [{ data: Object.values(categoryData), backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'], borderWidth: 0, hoverOffset: 8 }] }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: Chart.defaults.color } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.raw)}` } } } });
            
            const topProductsData = completedVendas.reduce((acc, v) => { v.items.forEach(i => { acc[i.produtoNome] = (acc[i.produtoNome] || 0) + (i.quantidade * i.precoUnitario); }); return acc; }, {});
            const sortedProducts = Object.entries(topProductsData).sort(([,a],[,b]) => b-a).slice(0, 5);
            renderChart('topProductsChart', 'bar', { labels: sortedProducts.map(p=>p[0]), datasets: [{ label: 'Faturamento', data: sortedProducts.map(p=>p[1]), backgroundColor: '#3b82f6', borderRadius: 4 }] }, { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => formatCurrency(ctx.raw) } } }, scales: { x: { ticks: { color: Chart.defaults.color, callback: (v) => formatCurrency(v) }, grid: { color: Chart.defaults.borderColor } }, y: { ticks: { color: Chart.defaults.color }, grid: { display: false } } } });
            
            const salesByWeekday = Array(7).fill(0); const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            completedVendas.forEach(v => { const day = new Date(v.data).getUTCDay(); salesByWeekday[day] += v.total; });
            renderChart('salesByWeekdayChart', 'bar', { labels: weekdays, datasets: [{ label: 'Faturamento', data: salesByWeekday, backgroundColor: ['#8b5cf6', '#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6'], borderRadius: 4 }] }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => formatCurrency(ctx.raw) } } }, scales: { x: { ticks: { color: Chart.defaults.color }, grid: { display: false } }, y: { ticks: { color: Chart.defaults.color, callback: (v) => formatCurrency(v) }, grid: { color: Chart.defaults.borderColor } } } });

            const paymentData = completedVendas.reduce((acc, v) => { v.pagamentos.forEach(p => { acc[p.method] = (acc[p.method] || 0) + p.amount; }); return acc; }, {});
            renderChart('paymentMethodChart', 'doughnut', { labels: Object.keys(paymentData), datasets: [{ data: Object.values(paymentData), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'], borderWidth: 0, hoverOffset: 8 }] }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: Chart.defaults.color } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.raw)}` } } } });

            const monthlySales = {}, monthlyCosts = {};
            for(let i=11; i >= 0; i--) { const d = new Date(); d.setMonth(d.getMonth() - i); const key = d.toLocaleString('default', { month: 'short', year: '2-digit' }); monthlySales[key] = 0; monthlyCosts[key] = 0; }
            completedVendas.forEach(v => { const d = new Date(v.data); const key = d.toLocaleString('default', { month: 'short', year: '2-digit' }); if(monthlySales.hasOwnProperty(key)) monthlySales[key] += v.total; });
            custosData.forEach(c => { const d = new Date(c.data); const key = d.toLocaleString('default', { month: 'short', year: '2-digit' }); if(monthlyCosts.hasOwnProperty(key)) monthlyCosts[key] += c.valor; });
            const sortedMonths = Object.keys(monthlySales);
            renderChart('revenueVsCostsChart', 'bar', { labels: sortedMonths, datasets: [ { label: 'Receita', data: sortedMonths.map(m=>monthlySales[m]), backgroundColor: '#10b981', borderRadius: 4 }, { label: 'Custo', data: sortedMonths.map(m=>monthlyCosts[m]), backgroundColor: '#ef4444', borderRadius: 4 } ] }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: {color: Chart.defaults.color}}, tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` } } }, scales: { x: { ticks: { color: Chart.defaults.color }, grid: { display: false } }, y: { ticks: { color: Chart.defaults.color, callback: (v) => formatCurrency(v) }, grid: { color: Chart.defaults.borderColor } } } });

            const costsByCategory = custosData.reduce((acc, c) => { acc[c.categoria] = (acc[c.categoria] || 0) + c.valor; return acc; }, {});
            renderChart('costsByCategoryChart', 'doughnut', { labels: Object.keys(costsByCategory), datasets: [{ data: Object.values(costsByCategory), backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'], borderWidth: 0, hoverOffset: 8 }] }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: Chart.defaults.color } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.raw)}` } } } });
        
            const costsBySupplier = custosData.reduce((acc, c) => {
                const fornecedor = allFornecedores.find(f => f.Id === c.fornecedorId);
                const nomeFornecedor = fornecedor ? fornecedor.nome : "Sem Fornecedor";
                acc[nomeFornecedor] = (acc[nomeFornecedor] || 0) + c.valor;
                return acc;
            }, {});
            renderChart('costsBySupplierChart', 'bar', { labels: Object.keys(costsBySupplier), datasets: [{ label: 'Total Gasto', data: Object.values(costsBySupplier), backgroundColor: '#f59e0b', borderRadius: 4 }] }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => formatCurrency(ctx.raw) } } }, scales: { x: { ticks: { color: Chart.defaults.color, callback: (v) => formatCurrency(v) }, grid: { color: Chart.defaults.borderColor } }, y: { ticks: { color: Chart.defaults.color }, grid: { display: false } } } });

            const costsByPaymentStatus = custosData.reduce((acc, c) => { const status = c.status || 'Não definido'; acc[status] = (acc[status] || 0) + c.valor; return acc; }, {});
            renderChart('costsByPaymentStatusChart', 'doughnut', { labels: Object.keys(costsByPaymentStatus), datasets: [{ data: Object.values(costsByPaymentStatus), backgroundColor: ['#10b981', '#f59e0b'], borderWidth: 0, hoverOffset: 8 }] }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: Chart.defaults.color } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.raw)}` } } } });
        };
        
        const applyFiltersAndRender = () => {
            let filteredProds = [...allProdutos];
            if(searchProdutoInput.value) filteredProds = filteredProds.filter(p => p.nome.toLowerCase().includes(searchProdutoInput.value.toLowerCase()));
            if(filterCategoria.value !== 'todos') filteredProds = filteredProds.filter(p => p.categoria === filterCategoria.value);
            if(filterStatusEstoque.value !== 'todos') filteredProds = filteredProds.filter(p => getStockStatus(p).k === filterStatusEstoque.value);
            renderEstoqueView(filteredProds);

            let filteredVendas = [...allVendas];
            if (filterStartDate.value) filteredVendas = filteredVendas.filter(v => new Date(v.data) >= new Date(filterStartDate.value + 'T00:00:00'));
            if (filterEndDate.value) filteredVendas = filteredVendas.filter(v => new Date(v.data) <= new Date(filterEndDate.value + 'T23:59:59'));
            renderVendasView(filteredVendas);

            let filteredCustos = [...allCustos];
            if (filterCustoStartDate.value) filteredCustos = filteredCustos.filter(c => new Date(c.data) >= new Date(filterCustoStartDate.value + 'T00:00:00'));
            if (filterCustoEndDate.value) filteredCustos = filteredCustos.filter(c => new Date(c.data) <= new Date(filterCustoEndDate.value + 'T23:59:59'));
            if (filterCustoFornecedor.value !== 'todos') filteredCustos = filteredCustos.filter(c => c.fornecedorId == filterCustoFornecedor.value);
            if (filterCustoStatus.value !== 'todos') filteredCustos = filteredCustos.filter(c => c.status === filterCustoStatus.value);
            renderCustosView(filteredCustos);
            
            let dashboardVendas = allVendas;
            let dashboardCustos = allCustos;
            if (dashboardFilterStartDate.value) {
                dashboardVendas = dashboardVendas.filter(v => new Date(v.data) >= new Date(dashboardFilterStartDate.value + 'T00:00:00'));
                dashboardCustos = dashboardCustos.filter(c => new Date(c.data) >= new Date(dashboardFilterStartDate.value + 'T00:00:00'));
            }
            if (dashboardFilterEndDate.value) {
                dashboardVendas = dashboardVendas.filter(v => new Date(v.data) <= new Date(dashboardFilterEndDate.value + 'T23:59:59'));
                dashboardCustos = dashboardCustos.filter(c => new Date(c.data) <= new Date(dashboardFilterEndDate.value + 'T23:59:59'));
            }
            renderDashboard(dashboardVendas, allProdutos, dashboardCustos);
            renderPendentesView();
        };
        
        const populateFiltersAndForms = () => {
            const categorias = [...new Set(allProdutos.map(p => p.categoria))].sort();
            filterCategoria.innerHTML = '<option value="todos">Todas Categorias</option>' + categorias.map(c => `<option value="${c}">${c}</option>`).join('');
            
            const costSupplierSelect = document.getElementById('cost-supplier');
            const filterCostSupplierSelect = document.getElementById('filterCustoFornecedor');
            const supplierOptions = allFornecedores.map(f => `<option value="${f.Id}">${f.nome}</option>`).join('');
            costSupplierSelect.innerHTML = '<option value="">Nenhum</option>' + supplierOptions;
            filterCostSupplierSelect.innerHTML = '<option value="todos">Todos Fornecedores</option>' + supplierOptions;
        };
        
        const loadData = async () => { try { const [prods, vendas, custos, fornecedores, funcionarios] = await Promise.all([api.getProdutos(), api.getVendas(), api.getCustos(), api.getFornecedores(), api.getFuncionarios()]); allProdutos = prods.list || []; allVendas = vendas.list || []; allCustos = custos.list || []; allFornecedores = fornecedores.list || []; allFuncionarios = funcionarios.list || []; populateFiltersAndForms(); applyFiltersAndRender(); renderGestaoView(); } catch (error) { console.error("Erro ao carregar dados:", error); } };
        
        const switchPage = (pageId) => {
            ['Dashboard', 'Estoque', 'Vendas', 'Custos', 'Gestao'].forEach(p => { const page = document.getElementById(`${p.toLowerCase()}Page`); const btn = document.getElementById(`page${p}Btn`); if(page) page.classList.add('hidden'); if(btn) btn.classList.remove('page-btn-active'); });
            document.getElementById(`${pageId.toLowerCase()}Page`).classList.remove('hidden'); document.getElementById(`page${pageId}Btn`).classList.add('page-btn-active');
        };

        const createSearchableDropdown = (inputId, optionsDivId, options) => {
            const input = document.getElementById(inputId);
            const optionsDiv = document.getElementById(optionsDivId);
            const renderOptions = (filter) => {
                optionsDiv.innerHTML = options.filter(o => o.toLowerCase().includes(filter.toLowerCase())).map(o => `<div class="p-2 hover:bg-gray-700 cursor-pointer search-results-option">${o}</div>`).join('');
            };
            input.addEventListener('focus', () => { renderOptions(input.value); optionsDiv.classList.remove('hidden'); });
            input.addEventListener('input', () => renderOptions(input.value));
            optionsDiv.addEventListener('click', (e) => { if(e.target.tagName === 'DIV'){ input.value = e.target.textContent; optionsDiv.classList.add('hidden'); } });
            document.addEventListener('click', (e) => { if (!input.contains(e.target) && !optionsDiv.contains(e.target)) optionsDiv.classList.add('hidden'); });
        };
        
        addProdutoBtn.addEventListener('click', () => { modalTitle.textContent = "Adicionar Novo Produto"; addEditForm.reset(); addEditForm['edit-id'].value = ''; addEditModal.classList.remove('hidden'); createSearchableDropdown('edit-marca', 'edit-marca-options', [...new Set(allProdutos.map(p => p.marca))]); createSearchableDropdown('edit-categoria', 'edit-categoria-options', [...new Set(allProdutos.map(p => p.categoria))]); });

        estoqueList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            if (btn.classList.contains('delete-btn')) {
                deleteModal.querySelector('p').textContent = 'Tem certeza de que deseja apagar este produto? O histórico de vendas não será alterado.';
                confirmDelete.dataset.id = btn.dataset.id;
                confirmDelete.dataset.type = 'product';
                deleteModal.classList.remove('hidden');
            }
            else if (btn.classList.contains('edit-btn')) {
                modalTitle.textContent = "Editar Produto";
                const item = JSON.parse(btn.dataset.item);
                for(const key in item) { if(addEditForm.elements[`edit-${key}`]) addEditForm.elements[`edit-${key}`].value = item[key]; }
                addEditForm.elements['edit-id'].value = item.Id;
                addEditModal.classList.remove('hidden');
                createSearchableDropdown('edit-marca', 'edit-marca-options', [...new Set(allProdutos.map(p => p.marca))]);
                createSearchableDropdown('edit-categoria', 'edit-categoria-options', [...new Set(allProdutos.map(p => p.categoria))]);
            } else if (btn.classList.contains('restock-btn')) {
                restockForm.elements['restock-id'].value = btn.dataset.id;
                document.getElementById('restockProductName').textContent = btn.dataset.name;
                restockModal.classList.remove('hidden');
            }
        });
        
        addEditForm.addEventListener('submit', async (e) => { e.preventDefault(); const id = addEditForm['edit-id'].value ? parseInt(addEditForm['edit-id'].value) : null; const data = { nome: addEditForm['edit-nome'].value, categoria: addEditForm['edit-categoria'].value, marca: addEditForm['edit-marca'].value, unidade: addEditForm['edit-unidade'].value, preco: parseFloat(addEditForm['edit-preco'].value), estoque: parseInt(addEditForm['edit-estoque'].value), estoqueMinimo: parseInt(addEditForm['edit-estoqueMinimo'].value)}; try { await (id ? api.patchProduto(id, data) : api.postProduto(data)); addEditModal.classList.add('hidden'); await loadData(); } catch (error) { console.error("Erro ao salvar:", error); } });
        restockForm.addEventListener('submit', async (e) => { e.preventDefault(); const id = parseInt(restockForm.elements['restock-id'].value); const quantity = parseInt(restockForm.elements['restock-quantity'].value); const product = allProdutos.find(p => p.Id === id); if(product && quantity > 0){ try { await api.patchProduto(id, { estoque: product.estoque + quantity }); restockModal.classList.add('hidden'); restockForm.reset(); await loadData(); } catch (error) { console.error("Erro ao repor estoque:", error); } } });
        
        confirmDelete.addEventListener('click', async (e) => {
            const id = parseInt(e.currentTarget.dataset.id);
            const type = e.currentTarget.dataset.type;
            try {
                if (type === 'cost') await api.deleteCusto(id);
                else if (type === 'product') await api.deleteProduto(id);
                else if (type === 'fornecedor') await api.deleteFornecedor(id);
                else if (type === 'funcionario') await api.deleteFuncionario(id);

                deleteModal.classList.add('hidden');
                await loadData();
            } catch (error) {
                console.error(`Erro ao apagar ${type}:`, error);
            } finally {
                e.currentTarget.removeAttribute('data-type');
            }
        });

        const updateCart = () => {
            cartItemsList.innerHTML = currentCart.map((item, index) => `<li class="flex justify-between items-center text-sm"><div>${item.quantidade}x ${item.produtoNome}</div><div class="flex items-center gap-2"><span>${formatCurrency(item.quantidade * item.precoUnitario)}</span><button data-index="${index}" class="remove-cart-item-btn text-red-400">&times;</button></div></li>`).join('');
            const total = currentCart.reduce((sum, item) => sum + item.quantidade * item.precoUnitario, 0);
            cartTotalEl.textContent = formatCurrency(total);
            finalizeSaleBtn.disabled = currentCart.length === 0;
        };
        addToCartBtn.addEventListener('click', () => {
            if(!selectedProductForSale || !saleQuantityInput.value > 0) return;
            const quantity = parseInt(saleQuantityInput.value);
            const existingItem = currentCart.find(item => item.produtoId === selectedProductForSale.Id);
            if(existingItem) { existingItem.quantidade += quantity; }
            else { currentCart.push({ produtoId: selectedProductForSale.Id, produtoNome: selectedProductForSale.nome, quantidade: quantity, precoUnitario: selectedProductForSale.preco }); }
            updateCart();
            selectedProductForSale = null;
            saleProductSearchInput.value = '';
            saleQuantityInput.value = 1;
        });
        cartItemsList.addEventListener('click', (e) => { if(e.target.classList.contains('remove-cart-item-btn')) { currentCart.splice(e.target.dataset.index, 1); updateCart(); } });
        
        finalizeSaleBtn.addEventListener('click', () => {
             if(currentCart.length === 0) { return; }
             const total = currentCart.reduce((sum, item) => sum + item.quantidade * item.precoUnitario, 0);
             document.getElementById('payment-amount').value = total.toFixed(2);
             paymentModal.classList.remove('hidden');
             updatePaymentModal();
        });
        
        const updatePaymentModal = () => {
            const total = currentCart.reduce((sum, item) => sum + item.quantidade * item.precoUnitario, 0);
            const paid = currentPayments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = total - paid;
            
            document.getElementById('paymentTotal').textContent = formatCurrency(total);
            document.getElementById('paymentRemaining').textContent = formatCurrency(remaining > 0 ? remaining : 0);
            document.getElementById('payment-amount').value = (remaining > 0 ? remaining : 0).toFixed(2);

            const changeEl = document.getElementById('paymentChange');
            const hasCashPayment = currentPayments.some(p => p.method === 'Dinheiro');
            const change = remaining < 0 ? -remaining : 0;
            
            if (hasCashPayment && change > 0) {
                changeEl.textContent = formatCurrency(change);
                changeEl.parentElement.classList.remove('hidden');
            } else {
                changeEl.parentElement.classList.add('hidden');
            }
            
            document.getElementById('payments-made-list').innerHTML = currentPayments.map(p => `<div>Pagamento: ${p.method} - ${formatCurrency(p.amount)}</div>`).join('');
            confirmPaymentBtn.disabled = remaining > 0.001;
        }

        addPaymentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const amountInput = document.getElementById('payment-amount');
            const amount = parseFloat(amountInput.value);
            const method = document.getElementById('payment-method').value;
            const total = currentCart.reduce((sum, item) => sum + item.quantidade * item.precoUnitario, 0);
            const paid = currentPayments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = total - paid;
            
            if (method !== 'Dinheiro' && amount > remaining + 0.001) {
                alert('Pagamentos com Cartão/Pix não podem exceder o valor restante.');
                amountInput.value = remaining.toFixed(2);
                return;
            }

            if(amount > 0) {
                currentPayments.push({method, amount});
                updatePaymentModal();
                amountInput.focus();
            }
        });

        cancelPayment.addEventListener('click', () => {
            paymentModal.classList.add('hidden');
            currentPayments = [];
        });

        confirmPaymentBtn.addEventListener('click', async () => {
            paymentModal.classList.add('hidden');
            const sale = { 
                items: currentCart, 
                total: currentCart.reduce((s, i) => s + i.quantidade * i.precoUnitario, 0), 
                pagamentos: currentPayments, 
                data: new Date().toISOString(),
                edited: isEditingSale,
                status: 'completed'
            };
            try {
                await api.postVenda(sale);
                for(const item of currentCart) { const product = allProdutos.find(p => p.Id === item.produtoId); await api.patchProduto(item.produtoId, { estoque: product.estoque - item.quantidade }); }
                currentCart = []; 
                currentPayments = [];
                isEditingSale = false;
                updateCart();
                saleFeedback.textContent = `Venda registrada!`; setTimeout(() => saleFeedback.textContent = '', 3000);
                await loadData();
            } catch(e) { console.error("Erro ao finalizar venda", e); }
        });
        
        const renderSaleProductResults = (filter) => {
            const filtered = allProdutos.filter(p => p.estoque > 0 && p.nome.toLowerCase().includes(filter.toLowerCase()));
            saleProductResults.innerHTML = filtered.map(p => `<div data-id="${p.Id}" class="p-2 hover:bg-gray-700 cursor-pointer search-results-option">${p.nome}</div>`).join('');
        };
        saleProductSearchInput.addEventListener('focus', () => { renderSaleProductResults(saleProductSearchInput.value); saleProductResults.classList.remove('hidden'); });
        saleProductSearchInput.addEventListener('input', () => renderSaleProductResults(saleProductSearchInput.value));
        saleProductResults.addEventListener('click', (e) => { if(e.target.dataset.id) { selectedProductForSale = allProdutos.find(p=> p.Id === parseInt(e.target.dataset.id)); saleProductSearchInput.value = selectedProductForSale.nome; saleProductResults.classList.add('hidden'); } });
        document.addEventListener('click', (e) => { if (!saleProductSearchInput.contains(e.target) && !saleProductResults.contains(e.target)) saleProductResults.classList.add('hidden'); });
        
        filterStartDate.addEventListener('input', () => { filterEndDate.min = filterStartDate.value; });
        filterEndDate.addEventListener('input', () => { filterStartDate.max = filterEndDate.value; });
        filterTodayBtn.addEventListener('click', () => { const today = new Date().toISOString().split('T')[0]; filterStartDate.value = today; filterEndDate.value = today; applyFiltersAndRender(); });
        resetFilterBtn.addEventListener('click', () => { filterStartDate.value = ''; filterEndDate.value = ''; filterStartDate.max = ''; filterEndDate.min = ''; applyFiltersAndRender(); });
        
        let shoppingListItems = [];
        const renderEditableShoppingList = () => {
            editableShoppingList.innerHTML = shoppingListItems.map((item, index) => `
                <li class="flex items-center gap-2 p-2 rounded-md" style="background-color: var(--btn-bg);">
                    <span class="flex-grow">${item.name}</span>
                    <input type="number" value="${item.qty}" min="1" data-index="${index}" class="custom-input w-24 shopping-item-qty">
                    <button data-index="${index}" class="remove-shopping-item-btn text-red-400 p-2">&times;</button>
                </li>
            `).join('');
        };
        prepareShoppingListBtn.addEventListener('click', () => {
            shoppingListItems = allProdutos.filter(p => p.estoque <= p.estoqueMinimo).map(p => ({name: p.nome, qty: 1}));
            renderEditableShoppingList();
            shoppingListModal.classList.remove('hidden');
        });

        const renderShoppingListResults = (filter) => {
            shoppingItemResults.innerHTML = allProdutos
                .filter(p => p.nome.toLowerCase().includes(filter.toLowerCase()))
                .map(p => `<div data-id="${p.Id}" class="p-2 hover:bg-gray-700 cursor-pointer search-results-option">${p.nome}</div>`)
                .join('');
        };

        shoppingItemSearch.addEventListener('focus', () => { renderShoppingListResults(shoppingItemSearch.value); shoppingItemResults.classList.remove('hidden'); });
        shoppingItemSearch.addEventListener('input', () => { selectedProductForShoppingList = null; renderShoppingListResults(shoppingItemSearch.value); });
        shoppingItemResults.addEventListener('click', (e) => { 
            if(e.target.dataset.id) { 
                selectedProductForShoppingList = allProdutos.find(p => p.Id === parseInt(e.target.dataset.id));
                shoppingItemSearch.value = selectedProductForShoppingList.nome;
                shoppingItemResults.classList.add('hidden');
            } 
        });
        document.addEventListener('click', (e) => { if (!shoppingItemSearch.contains(e.target) && !shoppingItemResults.contains(e.target)) shoppingItemResults.classList.add('hidden'); });

        addShoppingItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = shoppingItemSearch.value;
            const qtyInput = document.getElementById('shopping-item-qty');
            if(name) {
                shoppingListItems.push({name: name, qty: parseInt(qtyInput.value)});
                renderEditableShoppingList();
                addShoppingItemForm.reset();
                shoppingItemSearch.value = '';
                qtyInput.value = 1;
                selectedProductForShoppingList = null;
            }
        });
        editableShoppingList.addEventListener('change', (e) => {
            if(e.target.classList.contains('shopping-item-qty')) {
                const index = e.target.dataset.index;
                shoppingListItems[index].qty = parseInt(e.target.value);
            }
        });
        editableShoppingList.addEventListener('click', (e) => {
            if(e.target.classList.contains('remove-shopping-item-btn')) {
                shoppingListItems.splice(e.target.dataset.index, 1);
                renderEditableShoppingList();
            }
        });

        exportShoppingListPdfBtn.addEventListener('click', () => {
            const doc = new jsPDF();
            doc.setFontSize(18); doc.text("Lista de Compras - Lumi Doces", 14, 22);
            doc.setFontSize(11);
            let y = 30;
            shoppingListItems.forEach(item => { doc.text(`- ${item.name} (Quantidade: ${item.qty})`, 14, y); y += 7; });
            doc.save(`lista-de-compras-${new Date().toISOString().split('T')[0]}.pdf`);
        });

        document.getElementById('salesFilterButtons').addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;
            document.querySelectorAll('#salesFilterButtons button').forEach(b => b.classList.remove('filter-btn-active'));
            btn.classList.add('filter-btn-active');
            
            const period = btn.dataset.period;
            const endDate = new Date();
            let startDate = new Date();
            if(period === 'week') startDate.setDate(endDate.getDate() - 7);
            if(period === 'month') startDate.setMonth(endDate.getMonth() - 1);
            if(period === 'year') startDate.setFullYear(endDate.getFullYear() - 1);
            dashboardFilterStartDate.value = startDate.toISOString().split('T')[0];
            dashboardFilterEndDate.value = endDate.toISOString().split('T')[0];
            applyFiltersAndRender();
        });
        
        pendentesFilterButtons.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;
             document.querySelectorAll('#pendentesFilterButtons button').forEach(b => b.classList.remove('filter-btn-active'));
            btn.classList.add('filter-btn-active');
            renderPendentesView(btn.dataset.period);
        });

        vendasList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;

            saleToEditId = parseInt(btn.dataset.id);
            if(btn.classList.contains('edit-sale-btn')) {
                actionAfterPassword = 'editSale';
                passwordModal.classList.remove('hidden');
                document.getElementById('passwordInput').focus();
            } else if (btn.classList.contains('cancel-sale-btn')) {
                 actionAfterPassword = 'cancelSale';
                passwordModal.classList.remove('hidden');
                document.getElementById('passwordInput').focus();
            } else if (btn.classList.contains('view-sale-details-btn')) {
                const sale = allVendas.find(v => v.Id === saleToEditId);
                if(sale) {
                    const totalPaid = sale.pagamentos.reduce((acc, p) => acc + p.amount, 0);
                    const change = totalPaid - sale.total;
                    const content = `
                        <p><strong>ID da Venda:</strong> ${sale.Id}</p>
                        <p><strong>Data:</strong> ${new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full', timeStyle: 'short' }).format(new Date(sale.data))}</p>
                        ${sale.status === 'cancelled' && sale.cancellationDate ? `<p class="text-red-400"><strong>Cancelada em:</strong> ${new Intl.DateTimeFormat('pt-BR', { dateStyle: 'full', timeStyle: 'short' }).format(new Date(sale.cancellationDate))}</p>` : ''}
                        <hr class="my-2" style="border-color: var(--border-color);">
                        <p><strong>Itens:</strong></p>
                        <ul>${sale.items.map(i => `<li>${i.quantidade}x ${i.produtoNome} - ${formatCurrency(i.quantidade * i.precoUnitario)}</li>`).join('')}</ul>
                        <hr class="my-2" style="border-color: var(--border-color);">
                        <p><strong>Pagamentos:</strong></p>
                        <ul>${sale.pagamentos.map(p => `<li>${p.method}: ${formatCurrency(p.amount)}</li>`).join('')}</ul>
                        <hr class="my-2" style="border-color: var(--border-color);">
                        <p><strong>Total da Compra:</strong> ${formatCurrency(sale.total)}</p>
                        <p><strong>Total Pago:</strong> ${formatCurrency(totalPaid)}</p>
                        ${change > 0 ? `<p class="font-bold text-green-400"><strong>Troco:</strong> ${formatCurrency(change)}</p>` : ''}
                    `;
                    document.getElementById('saleDetailsContent').innerHTML = content;
                    saleDetailsModal.classList.remove('hidden');
                }
            }
        });

        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            const errorEl = document.getElementById('passwordError');
            if(password === 'Lumi10') {
                errorEl.textContent = '';
                passwordForm.reset();
                passwordModal.classList.add('hidden');
                
                const saleToEdit = allVendas.find(v => v.Id === saleToEditId);
                
                if (actionAfterPassword === 'editSale' && saleToEdit) {
                    for(const item of saleToEdit.items) {
                        const product = allProdutos.find(p => p.Id === item.produtoId);
                        await api.patchProduto(item.produtoId, { estoque: product.estoque + item.quantidade });
                    }
                    mockVendas = mockVendas.filter(v => v.Id !== saleToEditId);
                    currentCart = [...saleToEdit.items];
                    isEditingSale = true;
                    switchPage('Vendas');
                    updateCart();
                    await loadData();
                } else if (actionAfterPassword === 'cancelSale' && saleToEdit) {
                    confirmCancellation.dataset.id = saleToEditId;
                    confirmCancelModal.classList.remove('hidden');
                }
                saleToEditId = null;
                actionAfterPassword = null;

            } else {
                errorEl.textContent = 'Senha incorreta.';
            }
        });
        cancelPassword.addEventListener('click', () => {
            passwordForm.reset();
            document.getElementById('passwordError').textContent = '';
            passwordModal.classList.add('hidden');
        });

        confirmCancellation.addEventListener('click', async (e) => {
            const saleId = parseInt(e.currentTarget.dataset.id);
            const saleToCancel = allVendas.find(v => v.Id === saleId);
            if(saleToCancel) {
                for(const item of saleToCancel.items) {
                    const product = allProdutos.find(p => p.Id === item.produtoId);
                    await api.patchProduto(item.produtoId, { estoque: product.estoque + item.quantidade });
                }
                await api.patchVenda(saleId, { status: 'cancelled', cancellationDate: new Date().toISOString() });
                await loadData();
            }
            confirmCancelModal.classList.add('hidden');
        });
        cancelCancellation.addEventListener('click', () => confirmCancelModal.classList.add('hidden'));

        [pageDashboardBtn, pageEstoqueBtn, pageVendasBtn, pageCustosBtn, pageGestaoBtn].forEach(btn => btn.addEventListener('click', () => switchPage(btn.id.replace('page', '').replace('Btn', ''))));
        [filterCategoria, filterStatusEstoque, searchProdutoInput, filterStartDate, filterEndDate, dashboardFilterStartDate, dashboardFilterEndDate, filterCustoStartDate, filterCustoEndDate, filterCustoFornecedor, filterCustoStatus].forEach(el => el.addEventListener('input', applyFiltersAndRender));
        cancelEdit.addEventListener('click', () => addEditModal.classList.add('hidden')); cancelDelete.addEventListener('click', () => deleteModal.classList.add('hidden')); cancelRestock.addEventListener('click', () => { restockModal.classList.add('hidden'); restockForm.reset(); });
        closeShoppingListModal.addEventListener('click', () => shoppingListModal.classList.add('hidden'));
        closeSaleDetailsModal.addEventListener('click', () => saleDetailsModal.classList.add('hidden'));
        
        const applyTheme = (theme) => {
            document.documentElement.classList.toggle('light-theme', theme === 'light'); document.documentElement.classList.toggle('dark-theme', theme === 'dark');
            sunIcon.classList.toggle('hidden', theme === 'dark'); moonIcon.classList.toggle('hidden', theme === 'light');
            localStorage.setItem('theme', theme);
            const isDarkMode = theme !== 'light';
            Chart.defaults.color = isDarkMode ? '#e2e8f0' : '#475569';
            Chart.defaults.borderColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            if(allVendas.length) applyFiltersAndRender();
        };
        themeToggleBtn.addEventListener('click', () => applyTheme(localStorage.getItem('theme') === 'dark' ? 'light' : 'dark'));
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const foundUser = allFuncionarios.find(f => f.login === user && f.senha === pass);
            if (foundUser) {
                currentUser = foundUser;
                currentUserDisplay.textContent = `Olá, ${currentUser.nome}`;

                // Libera a tela de Custos para todos os usuários logados
                pageCustosBtn.classList.remove('hidden');

                if (currentUser.isAdmin) {
                    pageGestaoBtn.classList.remove('hidden');
                    pageDashboardBtn.classList.remove('hidden');
                } else {
                    pageGestaoBtn.classList.add('hidden');
                    pageDashboardBtn.classList.add('hidden');
                }
                loginPage.classList.add('hidden');
                appWrapper.classList.remove('hidden');
                switchPage('Vendas');
            } else {
                alert('Usuário ou senha inválidos!');
            }
        });

        logoutBtn.addEventListener('click', () => logoutModal.classList.remove('hidden'));
        cancelLogout.addEventListener('click', () => logoutModal.classList.add('hidden'));
        confirmLogout.addEventListener('click', () => {
            currentUser = null;
            logoutModal.classList.add('hidden');
            appWrapper.classList.add('hidden');
            loginPage.classList.remove('hidden');
            loginForm.reset();
        });

        // CUSTOS
        addCostForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            const id = addCostForm['cost-id'].value ? parseInt(addCostForm['cost-id'].value) : null;
            const data = {
                descricao: addCostForm['cost-description'].value,
                categoria: addCostForm['cost-category'].value,
                data: addCostForm['cost-date'].value,
                valor: parseFloat(addCostForm['cost-value'].value),
                fornecedorId: addCostForm['cost-supplier'].value ? parseInt(addCostForm['cost-supplier'].value) : null,
                status: addCostForm['cost-status'].value
            };
            if(id) {
                await api.patchCusto(id, data);
            } else {
                await api.postCusto(data);
            }
            addCostForm.reset();
            addCostForm['cost-id'].value = '';
            saveCostBtn.textContent = 'Adicionar Custo';
            await loadData();
        });

        costsList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;

            if (btn.classList.contains('edit-cost-btn')) {
                const item = JSON.parse(btn.dataset.item);
                addCostForm['cost-id'].value = item.Id;
                addCostForm['cost-description'].value = item.descricao;
                addCostForm['cost-category'].value = item.categoria;
                addCostForm['cost-date'].value = item.data.split('T')[0];
                addCostForm['cost-value'].value = item.valor;
                addCostForm['cost-supplier'].value = item.fornecedorId || '';
                addCostForm['cost-status'].value = item.status || 'Pago';
                saveCostBtn.textContent = 'Salvar Alterações';
            } else if (btn.classList.contains('delete-cost-btn')) {
                deleteModal.querySelector('p').textContent = 'Tem certeza de que deseja apagar este custo? Esta ação não pode ser desfeita.';
                confirmDelete.dataset.id = btn.dataset.id;
                confirmDelete.dataset.type = 'cost';
                deleteModal.classList.remove('hidden');
            }
        });

        // --- GESTÃO ---
        const renderGestaoView = () => {
            fornecedoresList.innerHTML = allFornecedores.map(f => `
                <tr class="border-b" style="border-color: var(--border-color);">
                    <td class="px-4 py-3 text-sm font-medium">${f.nome}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${f.telefone}</td>
                    <td class="px-4 py-3 text-center"><div class="flex items-center justify-center gap-1">
                        <a href="https://wa.me/55${f.telefone.replace(/\D/g,'')}" target="_blank" class="action-btn" title="WhatsApp"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-green-500" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943s-.182-.15-.38-.25"/></svg></a>
                        <button class="action-btn edit-fornecedor-btn" data-item='${JSON.stringify(f)}' title="Editar"><svg class="pointer-events-none text-blue-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V12h2.293z"/></svg></button>
                        <button class="action-btn delete-fornecedor-btn" data-id="${f.Id}" title="Apagar"><svg class="pointer-events-none text-red-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button>
                    </div></td>
                </tr>`).join('');
            
            funcionariosList.innerHTML = allFuncionarios.map(f => `
                 <tr class="border-b" style="border-color: var(--border-color);">
                    <td class="px-4 py-3 text-sm font-medium">${f.nome}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${f.cargo}</td>
                    <td class="px-4 py-3 text-center"><div class="flex items-center justify-center gap-1">
                        <a href="https://wa.me/55${f.telefone.replace(/\D/g,'')}" target="_blank" class="action-btn" title="WhatsApp"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-green-500" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943s-.182-.15-.38-.25"/></svg></a>
                        <button class="action-btn edit-funcionario-btn" data-item='${JSON.stringify(f)}' title="Editar"><svg class="pointer-events-none text-blue-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V12h2.293z"/></svg></button>
                        <button class="action-btn delete-funcionario-btn" data-id="${f.Id}" title="Apagar"><svg class="pointer-events-none text-red-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button>
                    </div></td>
                </tr>`).join('');
        };
        addFornecedorBtn.addEventListener('click', () => { document.getElementById('fornecedorModalTitle').textContent = "Adicionar Fornecedor"; fornecedorForm.reset(); fornecedorForm['fornecedor-id'].value = ''; fornecedorModal.classList.remove('hidden'); });
        addFuncionarioBtn.addEventListener('click', () => { document.getElementById('funcionarioModalTitle').textContent = "Adicionar Funcionário"; funcionarioForm.reset(); funcionarioForm['funcionario-id'].value = ''; funcionarioModal.classList.remove('hidden'); });
        cancelFornecedor.addEventListener('click', () => fornecedorModal.classList.add('hidden'));
        cancelFuncionario.addEventListener('click', () => funcionarioModal.classList.add('hidden'));

        fornecedorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = fornecedorForm['fornecedor-id'].value ? parseInt(fornecedorForm['fornecedor-id'].value) : null;
            const data = {
                nome: fornecedorForm['fornecedor-nome'].value,
                contato: fornecedorForm['fornecedor-contato'].value,
                telefone: fornecedorForm['fornecedor-telefone'].value,
                categoria: fornecedorForm['fornecedor-categoria'].value,
            };
            try {
                await (id ? api.patchFornecedor(id, data) : api.postFornecedor(data));
                fornecedorModal.classList.add('hidden');
                await loadData();
            } catch (error) { console.error('Erro ao salvar fornecedor:', error); }
        });

        funcionarioForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = funcionarioForm['funcionario-id'].value ? parseInt(funcionarioForm['funcionario-id'].value) : null;
            const data = {
                nome: funcionarioForm['funcionario-nome'].value,
                cargo: funcionarioForm['funcionario-cargo'].value,
                telefone: funcionarioForm['funcionario-telefone'].value,
                login: funcionarioForm['funcionario-login'].value,
                senha: funcionarioForm['funcionario-senha'].value,
                isAdmin: funcionarioForm['funcionario-admin'].checked
            };
            try {
                await (id ? api.patchFuncionario(id, data) : api.postFuncionario(data));
                funcionarioModal.classList.add('hidden');
                await loadData();
            } catch (error) { console.error('Erro ao salvar funcionário:', error); }
        });

        fornecedoresList.addEventListener('click', (e) => {
            const btn = e.target.closest('button'); if(!btn) return;
            if(btn.classList.contains('edit-fornecedor-btn')) {
                const item = JSON.parse(btn.dataset.item);
                document.getElementById('fornecedorModalTitle').textContent = "Editar Fornecedor";
                fornecedorForm['fornecedor-id'].value = item.Id;
                fornecedorForm['fornecedor-nome'].value = item.nome;
                fornecedorForm['fornecedor-contato'].value = item.contato;
                fornecedorForm['fornecedor-telefone'].value = item.telefone;
                fornecedorForm['fornecedor-categoria'].value = item.categoria;
                fornecedorModal.classList.remove('hidden');
            }
            if(btn.classList.contains('delete-fornecedor-btn')) {
                deleteModal.querySelector('p').textContent = 'Tem certeza que deseja apagar este fornecedor?';
                confirmDelete.dataset.id = btn.dataset.id;
                confirmDelete.dataset.type = 'fornecedor';
                deleteModal.classList.remove('hidden');
            }
        });

         funcionariosList.addEventListener('click', (e) => {
            const btn = e.target.closest('button'); if(!btn) return;
            if(btn.classList.contains('edit-funcionario-btn')) {
                const item = JSON.parse(btn.dataset.item);
                document.getElementById('funcionarioModalTitle').textContent = "Editar Funcionário";
                funcionarioForm['funcionario-id'].value = item.Id;
                funcionarioForm['funcionario-nome'].value = item.nome;
                funcionarioForm['funcionario-cargo'].value = item.cargo;
                funcionarioForm['funcionario-telefone'].value = item.telefone;
                funcionarioForm['funcionario-login'].value = item.login;
                funcionarioForm['funcionario-senha'].value = item.senha;
                funcionarioForm['funcionario-admin'].checked = item.isAdmin || false;
                funcionarioModal.classList.remove('hidden');
            }
            if(btn.classList.contains('delete-funcionario-btn')) {
                deleteModal.querySelector('p').textContent = 'Tem certeza que deseja apagar este funcionário?';
                confirmDelete.dataset.id = btn.dataset.id;
                confirmDelete.dataset.type = 'funcionario';
                deleteModal.classList.remove('hidden');
            }
        });
        
        // Relatórios
        generateReportBtn.addEventListener('click', () => reportModal.classList.remove('hidden'));
        cancelReport.addEventListener('click', () => reportModal.classList.add('hidden'));
        reportForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            generatePdfReport(reportType, startDate, endDate);
            reportModal.classList.add('hidden');
        });

        function generatePdfReport(type, start, end) {
            const doc = new jsPDF();
            const startDate = new Date(start + 'T00:00:00');
            const endDate = new Date(end + 'T23:59:59');

            doc.setFontSize(18);
            doc.text("Relatório Lumi Doces", 14, 22);
            doc.setFontSize(11);
            doc.text(`Período: ${startDate.toLocaleDateString('pt-BR')} a ${endDate.toLocaleDateString('pt-BR')}`, 14, 30);
            
            const salesData = allVendas.filter(v => new Date(v.data) >= startDate && new Date(v.data) <= endDate && v.status === 'completed');
            const costsData = allCustos.filter(c => new Date(c.data) >= startDate && new Date(c.data) <= endDate);

            if (type === 'vendas' || type === 'geral') {
                const totalVendas = salesData.reduce((sum, v) => sum + v.total, 0);
                doc.autoTable({
                    startY: 40,
                    head: [['Data', 'Itens', 'Pagamento', 'Total']],
                    body: salesData.map(v => [
                        new Date(v.data).toLocaleString('pt-BR'),
                        v.items.map(i => `${i.quantidade}x ${i.produtoNome}`).join(', '),
                        v.pagamentos.map(p=>p.method).join(', '),
                        formatCurrency(v.total)
                    ]),
                    foot: [['Total de Vendas', '', '', formatCurrency(totalVendas)]],
                    theme: 'grid'
                });
            }

            if (type === 'custos' || type === 'geral') {
                 const totalCustos = costsData.reduce((sum, c) => sum + c.valor, 0);
                 doc.autoTable({
                     startY: doc.previousAutoTable ? doc.previousAutoTable.finalY + 10 : 40,
                     head: [['Data', 'Descrição', 'Categoria', 'Valor']],
                     body: costsData.map(c => [
                         new Date(c.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'}),
                         c.descricao,
                         c.categoria,
                         formatCurrency(c.valor)
                     ]),
                     foot: [['Total de Custos', '', '', formatCurrency(totalCustos)]],
                     theme: 'grid'
                 });
            }

            if(type === 'geral') {
                const totalVendas = salesData.reduce((sum, v) => sum + v.total, 0);
                const totalCustos = costsData.reduce((sum, c) => sum + c.valor, 0);
                const lucro = totalVendas - totalCustos;
                doc.setFontSize(14);
                doc.text('Balanço Final', 14, doc.autoTable.previous.finalY + 15);
                doc.setFontSize(11);
                doc.text(`Receita Bruta: ${formatCurrency(totalVendas)}`, 14, doc.autoTable.previous.finalY + 22);
                doc.text(`Total de Custos: ${formatCurrency(totalCustos)}`, 14, doc.autoTable.previous.finalY + 29);
                doc.text(`Lucro Bruto: ${formatCurrency(lucro)}`, 14, doc.autoTable.previous.finalY + 36);
            }


            doc.save(`relatorio-${type}-${new Date().toISOString().split('T')[0]}.pdf`);
        }


        applyTheme(localStorage.getItem('theme') || 'dark');
        loadData();
    </script>
</body>
</html>

